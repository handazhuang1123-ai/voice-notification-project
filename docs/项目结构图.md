# Voice Notification Project - 项目结构图

**更新日期**: 2025-01-20
**项目版本**: v2.0 (Node.js 日志查看器版本)

---

## 📊 总体架构图

```
voice-notification-project/
│
├── 🎯 核心功能层
│   ├── .claude/                          # Claude Code 集成
│   │   ├── hooks/                        # Hook 脚本
│   │   ├── modules/                      # 功能模块
│   │   └── data/                         # 运行时数据
│
├── 🖥️ 用户界面层
│   ├── viewers/                          # 可视化查看器
│   │   ├── log-viewer/                   # 日志查看器（Pip-Boy 风格）
│   │   ├── rag-memory/                   # RAG 记忆查看器
│   │   └── pip-boy-theme/                # 辐射 Pip-Boy 主题
│
├── 🔧 工具脚本层
│   ├── scripts/                          # 辅助工具
│   │   ├── viewers/                      # 查看器服务器
│   │   └── Install-*.ps1                 # 安装脚本
│
├── 📚 依赖库层
│   ├── lib/                              # 本地依赖库
│   ├── modules/                          # PowerShell 模块
│   └── Package/                          # 第三方包
│
└── 📖 文档层
    ├── docs/                             # 技术文档
    ├── tests/                            # 测试脚本
    └── README.md                         # 项目说明
```

---

## 🗂️ 详细目录结构

### 1️⃣ 根目录文件

| 文件 | 作用 | 类型 |
|------|------|------|
| `README.md` | 项目总体说明文档 | 📖 文档 |
| `PSScriptAnalyzerSettings.psd1` | PowerShell 代码检查规则 | ⚙️ 配置 |
| `.gitignore` | Git 忽略规则 | ⚙️ 配置 |
| `.gitattributes` | Git 换行符配置 | ⚙️ 配置 |
| `.editorconfig` | 编辑器格式规范 | ⚙️ 配置 |
| **`启动日志查看器.cmd`** ⭐ | 快速启动日志查看器 | 🚀 快捷方式 |
| **`启动日志查看器-首次运行.cmd`** | 首次启动（完整检查） | 🚀 快捷方式 |
| `打开语音配置界面.vbs` | 打开语音配置 GUI | 🚀 快捷方式 |
| `错误监控面板.lnk` | 打开错误监控面板 | 🚀 快捷方式 |
| `创建监控面板快捷方式.ps1` | 创建快捷方式脚本 | 🔧 工具 |

---

### 2️⃣ `.claude/` - Claude Code 集成目录

#### 📁 `.claude/hooks/` - Hook 脚本

```
.claude/hooks/
├── dispatcher.ps1                    # 🎯 统一调度器（主入口）
├── Show-ErrorDashboard.ps1           # 📊 错误监控面板
└── extensions/
    └── voice-summary/                # 🎤 语音播报扩展
        ├── config.json               # 扩展启用开关
        ├── voice-config.json         # 语音参数配置
        ├── voice-summary.ps1         # 🎯 主脚本
        ├── Show-VoiceConfigUI.ps1    # 🖥️ 配置界面
        ├── VoiceConfigUI.xaml        # WPF 界面定义
        ├── helpers/                  # 辅助模块
        │   ├── Extract-Messages.ps1      # 消息提取
        │   ├── Generate-Summary.ps1      # AI 总结生成
        │   ├── Play-EdgeTTS.ps1          # 语音播放（SSML）
        │   └── New-SSML.ps1              # SSML 生成
        └── logs/                     # 日志文件
            └── voice-unified.log     # 统一日志
```

**作用说明**：
- **dispatcher.ps1**: Hook 总调度器，协调各扩展
- **voice-summary.ps1**: 语音播报核心逻辑
  1. 提取 Claude 对话消息
  2. 调用 Ollama AI 生成摘要
  3. 使用 Edge-TTS 语音播报
  4. 记录错误和统计数据
- **helpers/**: 功能模块化，职责分离

#### 📁 `.claude/modules/` - 功能模块

```
.claude/modules/
├── ErrorMonitor.psm1             # 错误监控（统计/报告）
├── Logger.psm1                   # 统一日志（多目标输出）
├── VectorMemory.psm1             # 向量记忆（RAG 系统）
├── Invoke-PlayAudio.psm1         # 音频播放（MediaPlayer/SoundPlayer）
└── StringAlignment.psm1          # 中文字符对齐
```

**作用说明**：
- **ErrorMonitor.psm1**:
  - 统计组件调用次数
  - 记录错误日志
  - 生成错误报告
- **Logger.psm1**:
  - 统一日志接口
  - 多目标输出（文件/控制台）
  - 日志级别管理
- **VectorMemory.psm1**:
  - SQLite-vec 向量数据库
  - 对话历史记录
  - 语义搜索
- **Invoke-PlayAudio.psm1**:
  - MediaPlayer 主播放
  - SoundPlayer 备用播放
  - 错误处理和重试

#### 📁 `.claude/data/` - 运行时数据

```
.claude/data/
├── error-stats.json              # 错误统计数据
└── memory.db                     # 向量记忆数据库（SQLite）
```

---

### 3️⃣ `viewers/` - 可视化查看器

#### 📁 `viewers/log-viewer/` - 日志查看器 ⭐ 新版

```
viewers/log-viewer/
├── index.html                    # 主页面
├── favicon.svg                   # 图标
├── js/
│   ├── app.js                    # 应用主逻辑
│   ├── session-manager.js        # 会话管理
│   └── log-renderer.js           # 日志渲染
├── data/
│   └── logs.json                 # 导出的日志数据
└── README.md                     # 使用说明
```

**特性**：
- Pip-Boy 辐射风格 UI
- 两级导航（日期 → 会话）
- 实时更新（长轮询）
- 键盘导航支持

#### 📁 `viewers/pip-boy-theme/` - Pip-Boy 主题

```
viewers/pip-boy-theme/
├── css/
│   ├── pip-boy-colors.css        # 颜色变量
│   ├── pip-boy-base.css          # 基础样式
│   ├── pip-boy-crt.css           # CRT 屏幕效果
│   └── pip-boy-components.css    # 组件样式
├── fonts/
│   └── VT323.ttf                 # 终端字体
├── demo/
│   └── demo.html                 # 主题演示
└── README.md                     # 主题文档
```

**特性**：
- 辐射系列 Pip-Boy 风格
- CRT 扫描线效果
- 绿色荧光配色
- 复古终端字体

#### 📁 `viewers/rag-memory/` - RAG 记忆查看器

```
viewers/rag-memory/
├── index.html                    # 主页面
├── js/
│   └── app.js                    # 记忆浏览逻辑
└── data/
    └── memories.json             # 导出的记忆数据
```

---

### 4️⃣ `scripts/` - 工具脚本

#### 📁 `scripts/viewers/log-viewers/` - 日志查看器服务器

```
scripts/viewers/log-viewers/
├── node-server/                          # 🌟 Node.js 服务器（新版）
│   ├── src/                              # TypeScript 源码
│   │   ├── server.ts                     # HTTP 服务器
│   │   ├── export-logs.ts                # 日志导出
│   │   ├── file-watcher.ts               # 文件监听
│   │   ├── log-parser.ts                 # 日志解析
│   │   └── config.ts                     # 配置管理
│   ├── dist/                             # 编译输出
│   ├── config.json                       # 配置文件
│   ├── package.json                      # Node.js 项目配置
│   ├── tsconfig.json                     # TypeScript 配置
│   ├── .eslintrc.json                    # ESLint 规则
│   └── README.md                         # 详细文档
├── Start-NodeLogViewer.ps1               # ⭐ 启动脚本
└── archived/                             # 归档的 PowerShell 版本
    ├── Open-LogViewer.ps1                # 旧服务器
    ├── Export-LogsData.ps1               # 旧导出脚本
    ├── Apply-*.ps1                       # 修复脚本
    └── README.md                         # 归档说明
```

**Node.js 版本特性**：
- ✅ 异步非阻塞
- ✅ 高并发支持
- ✅ TypeScript 类型安全
- ✅ ESLint 代码检查
- ✅ 实时文件监听

#### 📁 `scripts/viewers/shared/` - 共享模块

```
scripts/viewers/shared/
└── ConvertTo-ViewerJson.ps1     # JSON 导出通用函数
```

#### 📁 `scripts/` - 根目录脚本

```
scripts/
├── Install-Dependencies.ps1              # 依赖安装脚本
├── Install-Dependencies-v2.ps1           # 依赖安装 v2
├── Initialize-MemoryDatabase.ps1         # 初始化向量数据库
└── Fix-VectorMemoryDatabase.ps1          # 修复数据库
```

---

### 5️⃣ `docs/` - 技术文档

#### 核心文档

| 文档 | 内容 |
|------|------|
| **`项目结构图.md`** | 本文档 |
| `PROJECT-STRUCTURE.md` | 项目结构说明（旧） |
| `PowerShell项目标准化最佳实践调研报告.md` | 编码规范 |
| **`Node.js迁移完成报告.md`** | 迁移总结 ⭐ |
| `PowerShell-HttpListener单线程阻塞问题解决方案调研报告.md` | 问题分析 |

#### 功能文档

| 分类 | 文档列表 |
|------|---------|
| **语音相关** | Edge-TTS情感表达、MP3播放方案、机器人音效 |
| **UI 相关** | WPF事件处理、中文字符对齐、沉浸式窗口 |
| **AI 相关** | Ollama中文总结、自我进化技术方案 |
| **RAG 相关** | VectorMemory使用指南、知识库扩展方案 |
| **查看器** | Pip-Boy日志浏览器、实时日志查看器 |

---

### 6️⃣ `lib/` & `modules/` - 依赖库

```
lib/
└── x64/
    ├── System.Data.SQLite.dll            # SQLite 库
    └── SQLite.Interop.dll                # SQLite 互操作

modules/
└── (PowerShell 模块目录)

Package/
├── sqlite-netFx46-binary-x64-*.zip       # SQLite 包
└── sqlite-vec-*.tar                      # SQLite-vec 扩展
```

---

### 7️⃣ `tests/` - 测试脚本

```
tests/
├── test-dispatcher.ps1                   # 调度器测试
└── README.md                             # 测试说明
```

---

## 🔄 数据流图

### 语音播报流程

```
用户提问 → Claude 回复
    ↓
dispatcher.ps1（Hook 触发）
    ↓
voice-summary.ps1
    ├─→ Extract-Messages.ps1（提取对话）
    ├─→ Generate-Summary.ps1（AI 总结）
    │       ↓
    │   Ollama API（本地 AI）
    │       ↓
    ├─→ New-SSML.ps1（生成 SSML）
    └─→ Play-EdgeTTS.ps1（语音播报）
            ↓
        Edge-TTS（云希/晓晓）
            ↓
        Invoke-PlayAudio.psm1（播放音频）
```

### 日志查看器流程

```
语音播报完成
    ↓
写入 voice-unified.log
    ↓
Node.js File Watcher（chokidar 监听）
    ↓
等待完成标记（60秒超时）
    ↓
export-logs.ts（解析日志）
    ↓
生成 logs.json
    ↓
通知浏览器客户端（长轮询）
    ↓
浏览器自动刷新显示
```

### 错误监控流程

```
组件执行
    ↓
ErrorMonitor.psm1（记录调用/错误）
    ↓
error-stats.json（保存统计）
    ↓
Show-ErrorDashboard.ps1（可视化显示）
```

---

## 🎯 关键文件快速索引

### 🚀 启动入口

| 文件 | 用途 |
|------|------|
| `启动日志查看器.cmd` | 快速启动日志查看器 |
| `打开语音配置界面.vbs` | 配置语音参数 |
| `错误监控面板.lnk` | 查看错误统计 |

### ⚙️ 配置文件

| 文件 | 配置内容 |
|------|---------|
| `.claude/hooks/extensions/voice-summary/config.json` | 扩展启用开关 |
| `.claude/hooks/extensions/voice-summary/voice-config.json` | 语音参数 |
| `scripts/viewers/log-viewers/node-server/config.json` | 服务器配置 |

### 📊 数据文件

| 文件 | 数据内容 |
|------|---------|
| `.claude/data/error-stats.json` | 错误统计 |
| `.claude/data/memory.db` | 向量记忆 |
| `viewers/log-viewer/data/logs.json` | 日志数据 |

---

## 📝 技术栈总览

### 后端技术

| 组件 | 技术 |
|------|------|
| **语音播报** | PowerShell 7.x + Edge-TTS |
| **AI 总结** | Ollama（本地 AI） |
| **向量记忆** | SQLite + sqlite-vec |
| **日志服务器** | Node.js 18+ + Express + TypeScript |
| **文件监听** | chokidar（Node.js） |

### 前端技术

| 组件 | 技术 |
|------|------|
| **日志查看器** | 原生 JavaScript + 长轮询 |
| **UI 主题** | Pip-Boy 辐射风格 CSS |
| **配置界面** | WPF + XAML |
| **错误监控** | PowerShell WPF |

### 开发工具

| 工具 | 用途 |
|------|------|
| **PSScriptAnalyzer** | PowerShell 代码检查 |
| **ESLint** | TypeScript 代码检查 |
| **Git Hooks** | 提交前自动检查 |
| **TypeScript** | 类型安全 |

---

## 🔧 维护指南

### 如何修改语音参数？

1. 双击 `打开语音配置界面.vbs`
2. 在 GUI 中调整参数
3. 点击"试听"测试
4. 点击"保存"应用

### 如何查看错误日志？

1. 双击 `错误监控面板.lnk`
2. 查看组件调用统计
3. 查看错误详情

### 如何启动日志查看器？

1. **首次启动**: 双击 `启动日志查看器-首次运行.cmd`
2. **之后启动**: 双击 `启动日志查看器.cmd`

### 如何修改服务器配置？

编辑 `scripts/viewers/log-viewers/node-server/config.json`：
- `server.port`: 修改端口号
- `fileWatcher.pollingIntervalMs`: 修改监听频率
- `fileWatcher.completionTimeoutSeconds`: 修改超时时间

---

## 📌 版本历史

- **v2.0** (2025-01-20): 迁移到 Node.js 服务器
- **v1.5** (2025-01-17): 添加 Pip-Boy 日志查看器
- **v1.0** (2024-11): 初始版本（PowerShell 服务器）

---

**维护者**: 壮爸
**最后更新**: 2025-01-20
