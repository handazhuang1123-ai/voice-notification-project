# PowerShell ä¸­æ–‡å­—ç¬¦å¯¹é½ - å¿«é€Ÿå‚è€ƒ

**æœ€åæ›´æ–°**: 2025-11-11

---

## ä¸€åˆ†é’Ÿè§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒé—®é¢˜
ä¸­æ–‡å­—ç¬¦åœ¨ç»ˆç«¯å  2 ä¸ªå­—ç¬¦å®½åº¦ï¼Œä½† `.Length` åªè¿”å› 1ï¼Œå¯¼è‡´ä½¿ç”¨ `.PadRight()` å¯¹é½æ—¶å³è¾¹æ¡†é”™ä½ã€‚

### å¿«é€Ÿè§£å†³
ä½¿ç”¨ PowerShell å†…ç½® APIï¼š`$Host.UI.RawUI.LengthInBufferCells()`

---

## æœ€å°å¯ç”¨ä»£ç 

```powershell
# 1. è®¡ç®—æ˜¾ç¤ºå®½åº¦
function Get-DisplayWidth($Text) {
    if ([string]::IsNullOrEmpty($Text)) { return 0 }
    return $Host.UI.RawUI.LengthInBufferCells($Text)
}

# 2. å³ä¾§å¡«å……ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
function Format-StringRight($Text, $Width) {
    $currentWidth = Get-DisplayWidth $Text
    if ($currentWidth -ge $Width) { return $Text }
    return $Text + (" " * ($Width - $currentWidth))
}

# 3. ä½¿ç”¨ç¤ºä¾‹
$line = "  â€¢ AIæ€»ç»“: å®Œæˆ"
$aligned = Format-StringRight $line 60
Write-Host "â•‘$alignedâ•‘"
```

---

## å¸¸è§åœºæ™¯

### åœºæ™¯ 1: å•è¡Œå¯¹é½
```powershell
$text = "é”™è¯¯æ•°é‡: 5"
$padded = Format-StringRight $text 40
Write-Host "â•‘$paddedâ•‘"
```

### åœºæ™¯ 2: å¤šè¡Œé¢æ¿
```powershell
$lines = @(
    "  â€¢ çŠ¶æ€: è¿è¡Œä¸­",
    "  â€¢ é”™è¯¯: 0",
    "  â€¢ å®Œæˆ: 100%"
)

$width = 50
Write-Host "â•”$("â•" * $width)â•—"
foreach ($line in $lines) {
    $padded = Format-StringRight $line $width
    Write-Host "â•‘$paddedâ•‘"
}
Write-Host "â•š$("â•" * $width)â•"
```

### åœºæ™¯ 3: åŠ¨æ€å®½åº¦
```powershell
# æ ¹æ®ç»ˆç«¯å®½åº¦è‡ªåŠ¨è°ƒæ•´
$terminalWidth = $Host.UI.RawUI.WindowSize.Width
$panelWidth = $terminalWidth - 10  # ç•™ 10 ä¸ªå­—ç¬¦è¾¹è·

$text = "è‡ªåŠ¨è°ƒæ•´å®½åº¦çš„æ–‡æœ¬"
$padded = Format-StringRight $text $panelWidth
Write-Host "â•‘$paddedâ•‘"
```

---

## æµ‹è¯•ä½ çš„å®ç°

```powershell
# å¿«é€ŸéªŒè¯
Get-DisplayWidth "Hello"      # åº”è¯¥è¿”å›: 5
Get-DisplayWidth "ä½ å¥½"        # åº”è¯¥è¿”å›: 4
Get-DisplayWidth "Helloä¸–ç•Œ"  # åº”è¯¥è¿”å›: 9

# å¯¹é½æ•ˆæœæµ‹è¯•
$tests = @("ASCII text", "ä¸­æ–‡æµ‹è¯•", "Mixedæ··åˆ")
foreach ($t in $tests) {
    $p = Format-StringRight $t 30
    Write-Host "â•‘$pâ•‘"
}
# æ‰€æœ‰å³è¾¹æ¡†åº”è¯¥å¯¹é½ï¼
```

---

## å¸¸è§é”™è¯¯æ’æŸ¥

### é—®é¢˜ï¼šè¾¹æ¡†è¿˜æ˜¯ä¸å¯¹é½
**åŸå› **: å­—ä½“ä¸æ”¯æŒ CJK æˆ–æ¯”ä¾‹ä¸æ˜¯ 1:2

**è§£å†³**:
```powershell
# Windows Terminal/PowerShell æ¨èå­—ä½“ï¼š
# - MS Gothic
# - SimSunï¼ˆå®‹ä½“ï¼‰
# - Sarasa Mono SCï¼ˆæ›´çº±é»‘ä½“ï¼‰

# VSCode è®¾ç½®ï¼ˆsettings.jsonï¼‰ï¼š
{
    "terminal.integrated.fontFamily": "Consolas, 'Microsoft YaHei Mono', monospace"
}
```

### é—®é¢˜ï¼šRawUI ä¸å¯ç”¨ï¼ˆè¿œç¨‹ä¼šè¯/åå°ä½œä¸šï¼‰
**è§£å†³**: ä½¿ç”¨åå¤‡æ–¹æ¡ˆ
```powershell
function Get-DisplayWidth($Text) {
    try {
        return $Host.UI.RawUI.LengthInBufferCells($Text)
    }
    catch {
        # åå¤‡ï¼šæ‰‹åŠ¨ä¼°ç®—
        $width = 0
        foreach ($char in $Text.ToCharArray()) {
            $code = [int][char]$char
            # CJK åŸºæœ¬æ±‰å­—åŒºï¼šU+4E00-U+9FFF
            if ($code -ge 0x4E00 -and $code -le 0x9FFF) {
                $width += 2
            }
            else {
                $width += 1
            }
        }
        return $width
    }
}
```

---

## å®Œæ•´æ¨¡å—ç‰ˆæœ¬

**ä½ç½®**: `.claude/modules/StringAlignment.psm1`

**ä½¿ç”¨**:
```powershell
Import-Module ".claude/modules/StringAlignment.psm1"

# å¯ç”¨å‡½æ•°ï¼š
Get-DisplayWidth "æ–‡æœ¬"           # è®¡ç®—æ˜¾ç¤ºå®½åº¦
Format-StringRight "æ–‡æœ¬" 40       # å³ä¾§å¡«å……
New-AlignedPanel $lines 60        # åˆ›å»ºå¯¹é½é¢æ¿
```

---

## æ€§èƒ½æç¤º

- âœ… **ä¼˜å…ˆä½¿ç”¨** `RawUI.LengthInBufferCells()`ï¼ˆåŸç”Ÿ C# å®ç°ï¼Œå¿«ï¼‰
- âš ï¸ **é¿å…å¾ªç¯** ä¸­é‡å¤è®¡ç®—ç›¸åŒå­—ç¬¦ä¸²çš„å®½åº¦ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
- âŒ **ä¸è¦** ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æˆ–å¤æ‚å­—ç¬¦åˆ†ç±»ï¼ˆæ…¢ï¼‰

---

## è¾¹æ¡†å­—ç¬¦å‚è€ƒ

| å­—ç¬¦ | Unicode | å®½åº¦ | ç”¨é€” |
|-----|---------|------|------|
| `â•‘` | U+2551 | 1 | æ¨èï¼ˆåŒç«–çº¿ï¼‰ |
| `â”‚` | U+2502 | 1 | å¯ç”¨ï¼ˆå•ç«–çº¿ï¼‰ |
| `â•` | U+2550 | 1 | æ¨èï¼ˆåŒæ¨ªçº¿ï¼‰ |
| `â”€` | U+2500 | 1 | å¯ç”¨ï¼ˆå•æ¨ªçº¿ï¼‰ |
| `â•”` | U+2554 | 1 | å·¦ä¸Šè§’ï¼ˆåŒçº¿ï¼‰ |
| `â•—` | U+2557 | 1 | å³ä¸Šè§’ï¼ˆåŒçº¿ï¼‰ |
| `â•š` | U+255A | 1 | å·¦ä¸‹è§’ï¼ˆåŒçº¿ï¼‰ |
| `â•` | U+255D | 1 | å³ä¸‹è§’ï¼ˆåŒçº¿ï¼‰ |

---

## ç›¸å…³èµ„æº

- **å®Œæ•´è°ƒç ”æŠ¥å‘Š**: [`PowerShellä¸­æ–‡å­—ç¬¦å¯¹é½è§£å†³æ–¹æ¡ˆè°ƒç ”æŠ¥å‘Š.md`](./PowerShellä¸­æ–‡å­—ç¬¦å¯¹é½è§£å†³æ–¹æ¡ˆè°ƒç ”æŠ¥å‘Š.md)
- **GitHub Issue**: [PowerShell #6290](https://github.com/PowerShell/PowerShell/issues/6290)
- **Unicode æ ‡å‡†**: [UAX #11: East Asian Width](http://www.unicode.org/reports/tr11/)

---

**å£®çˆ¸ä¸“å±æç¤º**: æŠŠè¿™ä¸¤ä¸ªå‡½æ•°å¤åˆ¶åˆ°ä½ çš„è„šæœ¬å¼€å¤´ï¼Œå°±èƒ½ç«‹å³è§£å†³å¯¹é½é—®é¢˜ï¼ğŸ¯
