# è‡ªæˆ‘è¿›åŒ–å®æ–½æŒ‡å— - æ–¹æ¡ˆ3å¿«é€Ÿå¼€å§‹

**ç‰ˆæœ¬**: 1.0
**æ—¥æœŸ**: 2025-01-13
**é€‚ç”¨**: PowerShell è¯­éŸ³é€šçŸ¥ç³»ç»Ÿ
**æ–¹æ¡ˆ**: çº¯ JSON + æ»‘åŠ¨çª—å£ï¼ˆé›¶ä¾èµ–ï¼‰

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—æä¾›**ç«‹å³å¯ç”¨**çš„å®æ–½ä»£ç ,å¸®åŠ©æ‚¨åœ¨**æœ¬å‘¨å†…**ä¸ºè¯­éŸ³é€šçŸ¥ç³»ç»Ÿæ·»åŠ è‡ªæˆ‘è¿›åŒ–èƒ½åŠ›ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**:
- âœ… é›¶ä¾èµ– - çº¯ PowerShell + JSON
- âœ… 15åˆ†é’Ÿéƒ¨ç½² - 3ä¸ªæ–‡ä»¶å³å¯è¿è¡Œ
- âœ… è½»é‡çº§ - å†…å­˜å ç”¨ < 10MB
- âœ… æ¸è¿›å¼ - éšä½¿ç”¨è‡ªåŠ¨ç§¯ç´¯å­¦ä¹ 

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²ï¼ˆ15åˆ†é’Ÿï¼‰

### æ­¥éª¤1: åˆ›å»ºè®°å¿†æ¨¡å—ï¼ˆ5åˆ†é’Ÿï¼‰

**æ–‡ä»¶**: `H:\HZH\Little-Projects\voice-notification-project\modules\SimpleMemory.psm1`

```powershell
#Requires -Version 5.1

<#
.SYNOPSIS
    Simple JSON-based memory system for voice notifications
    åŸºäº JSON çš„ç®€å•è®°å¿†ç³»ç»Ÿ

.DESCRIPTION
    Provides lightweight memory capabilities:
    - Sliding window storage (keep last N interactions)
    - Keyword extraction and matching
    - Preference statistics (emotion, keywords)
    - Context-aware prompt generation

.NOTES
    Author: å£®çˆ¸
    Version: 1.0
    Date: 2025-01-13
#>

# ============== åˆå§‹åŒ–å‡½æ•° ==============

function Initialize-SimpleMemory {
    <#
    .SYNOPSIS
        Initialize JSON-based simple memory
        åˆå§‹åŒ–åŸºäº JSON çš„ç®€å•è®°å¿†ç³»ç»Ÿ

    .PARAMETER MemoryPath
        Path to memory JSON file
        è®°å¿† JSON æ–‡ä»¶è·¯å¾„

    .PARAMETER WindowSize
        Maximum number of interactions to keep
        ä¿ç•™çš„æœ€å¤§äº¤äº’æ•°é‡

    .EXAMPLE
        $memory = Initialize-SimpleMemory
        Initialize with default settings

    .EXAMPLE
        $memory = Initialize-SimpleMemory -WindowSize 200
        Initialize with larger window size
    #>
    [CmdletBinding()]
    param(
        [string]$MemoryPath = (Join-Path $PSScriptRoot '..\data\simple-memory.json'),
        [int]$WindowSize = 100
    )

    # ç¡®ä¿ç›®å½•å­˜åœ¨
    $directory = Split-Path -Path $MemoryPath -Parent
    if (-not (Test-Path $directory)) {
        New-Item -ItemType Directory -Path $directory -Force | Out-Null
    }

    # åŠ è½½æˆ–åˆ›å»ºè®°å¿†
    if (Test-Path $MemoryPath) {
        try {
            $memory = Get-Content $MemoryPath -Raw -Encoding UTF8 | ConvertFrom-Json
            Write-Verbose "[SimpleMemory] Loaded existing memory: $($memory.interactions.Count) interactions"
        }
        catch {
            Write-Warning "[SimpleMemory] Failed to load memory, creating new: $_"
            $memory = New-EmptyMemory -WindowSize $WindowSize
        }
    }
    else {
        Write-Verbose "[SimpleMemory] Creating new memory file"
        $memory = New-EmptyMemory -WindowSize $WindowSize
    }

    return $memory
}

function New-EmptyMemory {
    <#
    .SYNOPSIS
        Create empty memory structure
        åˆ›å»ºç©ºç™½è®°å¿†ç»“æ„
    #>
    param(
        [int]$WindowSize = 100
    )

    return [PSCustomObject]@{
        interactions = @()
        preferences = [PSCustomObject]@{
            emotion_counts = [PSCustomObject]@{}
            common_keywords = [PSCustomObject]@{}
            response_patterns = @()
        }
        window_size = $WindowSize
        last_cleanup = (Get-Date).ToString("o")
        version = "1.0"
    }
}

# ============== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ==============

function Add-SimpleMemory {
    <#
    .SYNOPSIS
        Add interaction to simple memory with sliding window
        æ·»åŠ äº¤äº’åˆ°ç®€å•è®°å¿†ï¼ˆæ»‘åŠ¨çª—å£ï¼‰

    .PARAMETER Memory
        Memory object from Initialize-SimpleMemory
        è®°å¿†å¯¹è±¡

    .PARAMETER UserMessage
        User's message
        ç”¨æˆ·æ¶ˆæ¯

    .PARAMETER AiSummary
        AI-generated summary
        AI ç”Ÿæˆçš„æ€»ç»“

    .PARAMETER Emotion
        Emotion style used
        ä½¿ç”¨çš„æƒ…æ„Ÿé£æ ¼

    .EXAMPLE
        $memory = Add-SimpleMemory -Memory $memory `
            -UserMessage "åˆ›å»ºç”¨æˆ·æ‰‹å†Œ" `
            -AiSummary "å…ˆç”Ÿ,æ–‡æ¡£å·²åˆ›å»ºå®Œæˆ" `
            -Emotion "calm"
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [PSCustomObject]$Memory,

        [Parameter(Mandatory)]
        [string]$UserMessage,

        [Parameter(Mandatory)]
        [string]$AiSummary,

        [string]$Emotion = "calm",

        [bool]$Success = $true
    )

    # æå–å…³é”®è¯
    $keywords = Extract-SimpleKeywords -Text $UserMessage

    # åˆ›å»ºäº¤äº’è®°å½•
    $interaction = [PSCustomObject]@{
        id = if ($Memory.interactions.Count -gt 0) {
            ($Memory.interactions | Select-Object -Last 1).id + 1
        } else { 1 }
        timestamp = (Get-Date).ToString("o")
        user_message = $UserMessage
        ai_summary = $AiSummary
        emotion = $Emotion
        keywords = $keywords
        success = $Success
    }

    # æ·»åŠ åˆ°äº¤äº’åˆ—è¡¨
    $Memory.interactions += $interaction

    # æ›´æ–°æƒ…æ„Ÿåå¥½ç»Ÿè®¡
    Update-EmotionPreference -Memory $Memory -Emotion $Emotion

    # æ›´æ–°å…³é”®è¯é¢‘ç‡
    Update-KeywordFrequency -Memory $Memory -Keywords $keywords

    # æ»‘åŠ¨çª—å£æ¸…ç†ï¼ˆä¿ç•™æœ€è¿‘ N æ¡ï¼‰
    if ($Memory.interactions.Count -gt $Memory.window_size) {
        $keepCount = $Memory.window_size
        $Memory.interactions = $Memory.interactions | Select-Object -Last $keepCount
        $Memory.last_cleanup = (Get-Date).ToString("o")
        Write-Verbose "[SimpleMemory] Sliding window cleanup: kept last $keepCount interactions"
    }

    return $Memory
}

function Update-EmotionPreference {
    <#
    .SYNOPSIS
        Update emotion preference statistics
        æ›´æ–°æƒ…æ„Ÿåå¥½ç»Ÿè®¡
    #>
    param(
        [Parameter(Mandatory)]
        [PSCustomObject]$Memory,

        [Parameter(Mandatory)]
        [string]$Emotion
    )

    $emotionCounts = $Memory.preferences.emotion_counts

    # æ£€æŸ¥æ˜¯å¦å·²æœ‰è¯¥æƒ…æ„Ÿ
    $existingProp = $emotionCounts.PSObject.Properties | Where-Object { $_.Name -eq $Emotion }

    if ($existingProp) {
        $emotionCounts.$Emotion++
    }
    else {
        $emotionCounts | Add-Member -MemberType NoteProperty -Name $Emotion -Value 1
    }
}

function Update-KeywordFrequency {
    <#
    .SYNOPSIS
        Update keyword frequency statistics
        æ›´æ–°å…³é”®è¯é¢‘ç‡ç»Ÿè®¡
    #>
    param(
        [Parameter(Mandatory)]
        [PSCustomObject]$Memory,

        [Parameter(Mandatory)]
        [array]$Keywords
    )

    $commonKeywords = $Memory.preferences.common_keywords

    foreach ($kw in $Keywords) {
        $existingProp = $commonKeywords.PSObject.Properties | Where-Object { $_.Name -eq $kw }

        if ($existingProp) {
            $commonKeywords.$kw++
        }
        else {
            $commonKeywords | Add-Member -MemberType NoteProperty -Name $kw -Value 1
        }
    }
}

# ============== å…³é”®è¯æå– ==============

function Extract-SimpleKeywords {
    <#
    .SYNOPSIS
        Extract simple keywords using regex
        ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–ç®€å•å…³é”®è¯

    .PARAMETER Text
        Text to extract keywords from
        å¾…æå–å…³é”®è¯çš„æ–‡æœ¬

    .PARAMETER MaxKeywords
        Maximum number of keywords to return
        è¿”å›çš„æœ€å¤§å…³é”®è¯æ•°é‡

    .EXAMPLE
        $keywords = Extract-SimpleKeywords -Text "åˆ›å»ºç”¨æˆ·æ‰‹å†Œæ–‡æ¡£"
        # Returns: @("åˆ›å»º", "ç”¨æˆ·", "æ‰‹å†Œ", "æ–‡æ¡£")
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [string]$Text,

        [int]$MaxKeywords = 5
    )

    $allKeywords = @()

    # 1. æå–ä¸­æ–‡è¯ç»„ï¼ˆ2-4ä¸ªæ±‰å­—ï¼‰
    $chinesePattern = '[\u4e00-\u9fa5]{2,4}'
    $chineseMatches = [regex]::Matches($Text, $chinesePattern)

    foreach ($match in $chineseMatches) {
        $allKeywords += $match.Value
    }

    # 2. æå–è‹±æ–‡å•è¯ï¼ˆ3+å­—æ¯ï¼‰
    $englishPattern = '\b[a-zA-Z]{3,}\b'
    $englishMatches = [regex]::Matches($Text, $englishPattern)

    foreach ($match in $englishMatches) {
        $allKeywords += $match.Value.ToLower()
    }

    # 3. å»é‡å¹¶é™åˆ¶æ•°é‡
    $uniqueKeywords = $allKeywords | Select-Object -Unique | Select-Object -First $MaxKeywords

    return $uniqueKeywords
}

# ============== ä¸Šä¸‹æ–‡æ£€ç´¢ ==============

function Find-SimpleContext {
    <#
    .SYNOPSIS
        Find relevant context using keyword matching
        ä½¿ç”¨å…³é”®è¯åŒ¹é…æŸ¥æ‰¾ç›¸å…³ä¸Šä¸‹æ–‡

    .PARAMETER Memory
        Memory object
        è®°å¿†å¯¹è±¡

    .PARAMETER QueryText
        Query text to find similar interactions
        æŸ¥è¯¢æ–‡æœ¬

    .PARAMETER TopN
        Number of top results to return
        è¿”å›çš„ç»“æœæ•°é‡

    .EXAMPLE
        $context = Find-SimpleContext -Memory $memory -QueryText "åˆ›å»ºæ–‡æ¡£" -TopN 3
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [PSCustomObject]$Memory,

        [Parameter(Mandatory)]
        [string]$QueryText,

        [int]$TopN = 3
    )

    # æå–æŸ¥è¯¢å…³é”®è¯
    $queryKeywords = Extract-SimpleKeywords -Text $QueryText

    if ($queryKeywords.Count -eq 0) {
        Write-Verbose "[SimpleMemory] No keywords extracted from query"
        return @()
    }

    # è®¡ç®—æ¯ä¸ªäº¤äº’çš„åŒ¹é…åˆ†æ•°
    $scoredInteractions = @()

    foreach ($interaction in $Memory.interactions) {
        # è®¡ç®—å…³é”®è¯é‡å æ•°é‡
        $matchCount = 0
        foreach ($qk in $queryKeywords) {
            if ($interaction.keywords -contains $qk) {
                $matchCount++
            }
        }

        if ($matchCount -gt 0) {
            $scoredInteractions += [PSCustomObject]@{
                Interaction = $interaction
                Score = $matchCount
                MatchRate = [math]::Round($matchCount / $queryKeywords.Count, 2)
            }
        }
    }

    # æ’åºå¹¶è¿”å›å‰ N ä¸ª
    $results = $scoredInteractions |
        Sort-Object -Property Score -Descending |
        Select-Object -First $TopN |
        Select-Object -ExpandProperty Interaction

    Write-Verbose "[SimpleMemory] Found $($results.Count) matching interactions"

    return $results
}

# ============== è‡ªé€‚åº”æç¤ºè¯ç”Ÿæˆ ==============

function Get-SimpleAdaptivePrompt {
    <#
    .SYNOPSIS
        Generate adaptive prompt using simple context
        ä½¿ç”¨ç®€å•ä¸Šä¸‹æ–‡ç”Ÿæˆè‡ªé€‚åº”æç¤ºè¯

    .PARAMETER Memory
        Memory object
        è®°å¿†å¯¹è±¡

    .PARAMETER CurrentMessage
        Current user message
        å½“å‰ç”¨æˆ·æ¶ˆæ¯

    .EXAMPLE
        $prompt = Get-SimpleAdaptivePrompt -Memory $memory -CurrentMessage "åˆ›å»ºAPIæ–‡æ¡£"
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [PSCustomObject]$Memory,

        [Parameter(Mandatory)]
        [string]$CurrentMessage
    )

    # 1. æŸ¥æ‰¾ç›¸ä¼¼ä¸Šä¸‹æ–‡
    $contextInteractions = Find-SimpleContext -Memory $Memory -QueryText $CurrentMessage -TopN 3

    # 2. è·å–æœ€å¸¸ç”¨æƒ…æ„Ÿ
    $preferredEmotion = Get-PreferredEmotion -Memory $Memory

    # 3. æ„å»ºæç¤ºè¯
    if ($contextInteractions.Count -gt 0) {
        # æœ‰å†å²ä¸Šä¸‹æ–‡ - ç”Ÿæˆå¢å¼ºæç¤ºè¯
        $examples = $contextInteractions | ForEach-Object {
            "- ç”¨æˆ·: $($_.user_message)`n  æ’­æŠ¥: $($_.ai_summary)"
        }

        $enhancedPrompt = @"
ä½ æ˜¯ç”¨æˆ·çš„ä¸ªæ€§åŒ–AIåŠ©æ‰‹Jarvisã€‚æ ¹æ®ä»¥ä¸‹å†å²é£æ ¼ç”Ÿæˆè¯­éŸ³æ’­æŠ¥æ€»ç»“:

ã€å†å²ç›¸ä¼¼åœºæ™¯ã€‘
$($examples -join "`n")

ã€ç”¨æˆ·åå¥½æƒ…æ„Ÿã€‘
$preferredEmotion

ã€å½“å‰ä»»åŠ¡ã€‘
$CurrentMessage

ã€è¦æ±‚ã€‘
1. 60å­—ä»¥å†…çš„ç®€æ´æ€»ç»“
2. ä¿æŒä¸å†å²æ¡ˆä¾‹ç›¸ä¼¼çš„é£æ ¼
3. ä½¿ç”¨"å…ˆç”Ÿ"ç§°å‘¼ï¼ˆä¸­æ–‡ï¼‰æˆ–"sir"ï¼ˆè‹±æ–‡ï¼‰
4. æå–æœ€å…³é”®çš„1ä¸ªæ•°å­—æˆ–1ä¸ªç»“æœ
"@

        Write-Verbose "[SimpleMemory] Generated enhanced prompt with $($contextInteractions.Count) context examples"
    }
    else {
        # æ— å†å²ä¸Šä¸‹æ–‡ - ä½¿ç”¨åŸºç¡€æç¤ºè¯
        $enhancedPrompt = @"
ä½ æ˜¯ç”¨æˆ·çš„AIåŠ©æ‰‹Jarvisã€‚ä¸ºä»¥ä¸‹ä»»åŠ¡ç”Ÿæˆ60å­—ä»¥å†…çš„è¯­éŸ³æ’­æŠ¥æ€»ç»“:

ã€ä»»åŠ¡ã€‘
$CurrentMessage

ã€è¦æ±‚ã€‘
1. ç®€æ´ä¸“ä¸š
2. ä½¿ç”¨"å…ˆç”Ÿ"ç§°å‘¼ï¼ˆä¸­æ–‡ï¼‰æˆ–"sir"ï¼ˆè‹±æ–‡ï¼‰
3. æå–å…³é”®æ•°å­—æˆ–ç»“æœ
4. æƒ…æ„Ÿé£æ ¼: $preferredEmotion
"@

        Write-Verbose "[SimpleMemory] Generated basic prompt (no context)"
    }

    return $enhancedPrompt
}

function Get-PreferredEmotion {
    <#
    .SYNOPSIS
        Get most frequently used emotion
        è·å–æœ€å¸¸ç”¨çš„æƒ…æ„Ÿé£æ ¼
    #>
    param(
        [Parameter(Mandatory)]
        [PSCustomObject]$Memory
    )

    $emotionCounts = $Memory.preferences.emotion_counts
    $properties = $emotionCounts.PSObject.Properties

    if ($properties.Count -eq 0) {
        return "calm"  # é»˜è®¤å€¼
    }

    # æ‰¾åˆ°è®¡æ•°æœ€é«˜çš„æƒ…æ„Ÿ
    $maxEmotion = $properties | Sort-Object -Property Value -Descending | Select-Object -First 1

    return $maxEmotion.Name
}

# ============== æŒä¹…åŒ– ==============

function Save-SimpleMemory {
    <#
    .SYNOPSIS
        Save memory to JSON file
        ä¿å­˜è®°å¿†åˆ° JSON æ–‡ä»¶

    .PARAMETER Memory
        Memory object to save
        è¦ä¿å­˜çš„è®°å¿†å¯¹è±¡

    .PARAMETER Path
        Path to save JSON file
        ä¿å­˜ JSON æ–‡ä»¶çš„è·¯å¾„

    .EXAMPLE
        Save-SimpleMemory -Memory $memory
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [PSCustomObject]$Memory,

        [string]$Path = (Join-Path $PSScriptRoot '..\data\simple-memory.json')
    )

    try {
        $json = $Memory | ConvertTo-Json -Depth 10 -Compress:$false
        $json | Set-Content -Path $Path -Encoding UTF8 -Force
        Write-Verbose "[SimpleMemory] Memory saved: $($Memory.interactions.Count) interactions"
    }
    catch {
        Write-Warning "[SimpleMemory] Failed to save memory: $_"
    }
}

# ============== ç»Ÿè®¡åˆ†æ ==============

function Get-MemoryStatistics {
    <#
    .SYNOPSIS
        Get memory statistics for analysis
        è·å–è®°å¿†ç»Ÿè®¡ä¿¡æ¯ç”¨äºåˆ†æ

    .PARAMETER Memory
        Memory object
        è®°å¿†å¯¹è±¡

    .EXAMPLE
        $stats = Get-MemoryStatistics -Memory $memory
        $stats | Format-Table
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [PSCustomObject]$Memory
    )

    $emotionCounts = $Memory.preferences.emotion_counts.PSObject.Properties |
        ForEach-Object { [PSCustomObject]@{ Emotion = $_.Name; Count = $_.Value } } |
        Sort-Object -Property Count -Descending

    $keywordCounts = $Memory.preferences.common_keywords.PSObject.Properties |
        ForEach-Object { [PSCustomObject]@{ Keyword = $_.Name; Count = $_.Value } } |
        Sort-Object -Property Count -Descending |
        Select-Object -First 10

    $stats = [PSCustomObject]@{
        TotalInteractions = $Memory.interactions.Count
        WindowSize = $Memory.window_size
        LastCleanup = $Memory.last_cleanup
        TopEmotions = $emotionCounts
        TopKeywords = $keywordCounts
        SuccessRate = if ($Memory.interactions.Count -gt 0) {
            [math]::Round(
                ($Memory.interactions | Where-Object { $_.success }).Count /
                $Memory.interactions.Count * 100, 2
            )
        } else { 0 }
    }

    return $stats
}

# ============== å¯¼å‡ºå‡½æ•° ==============

Export-ModuleMember -Function @(
    'Initialize-SimpleMemory',
    'Add-SimpleMemory',
    'Find-SimpleContext',
    'Get-SimpleAdaptivePrompt',
    'Save-SimpleMemory',
    'Get-MemoryStatistics',
    'Extract-SimpleKeywords'
)
```

### æ­¥éª¤2: é›†æˆåˆ°ä¸»è„šæœ¬ï¼ˆ5åˆ†é’Ÿï¼‰

**æ–‡ä»¶**: `H:\HZH\Little-Projects\voice-notification-project\.claude\hooks\voice-notification.ps1`

åœ¨ä¸»è„šæœ¬ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼ˆæ‰¾åˆ°åˆé€‚çš„ä½ç½®æ’å…¥ï¼‰ï¼š

```powershell
# ============== åŠ è½½è®°å¿†æ¨¡å—ï¼ˆæ·»åŠ åˆ°æ¨¡å—åŠ è½½åŒºåŸŸï¼‰ ==============

if (-not $global:VoiceModulesLoaded) {
    # ... ç°æœ‰çš„æ¨¡å—åŠ è½½ ...

    # åŠ è½½ç®€å•è®°å¿†æ¨¡å—
    Import-Module (Join-Path $PSScriptRoot '..\modules\SimpleMemory.psm1') -Force

    # ... ç°æœ‰çš„æ ‡è®°è®¾ç½® ...
}

# ============== è®°å¿†å¢å¼ºé€»è¾‘ï¼ˆæ·»åŠ åˆ° AI æ€»ç»“ç”Ÿæˆä¹‹å‰ï¼‰ ==============

# åœ¨è°ƒç”¨ Ollama ç”Ÿæˆæ€»ç»“ä¹‹å‰ï¼Œæ·»åŠ è¿™æ®µä»£ç ï¼š

# åˆå§‹åŒ–è®°å¿†
$memory = Initialize-SimpleMemory

# ç”Ÿæˆè‡ªé€‚åº”æç¤ºè¯
$adaptivePrompt = Get-SimpleAdaptivePrompt -Memory $memory -CurrentMessage $UserMessage

# ä½¿ç”¨å¢å¼ºæç¤ºè¯ç”Ÿæˆæ€»ç»“
$AiSummary = Invoke-OllamaGenerate -Prompt $adaptivePrompt  # æ›¿æ¢åŸæœ‰çš„æç¤ºè¯

# ============== ä¿å­˜è®°å¿†ï¼ˆæ·»åŠ åˆ°æ—¥å¿—ä¿å­˜ä¹‹åï¼‰ ==============

# åœ¨æˆåŠŸç”Ÿæˆæ€»ç»“åï¼Œä¿å­˜åˆ°è®°å¿†ï¼š

if ($AiSummary) {
    $memory = Add-SimpleMemory -Memory $memory `
        -UserMessage $UserMessage `
        -AiSummary $AiSummary `
        -Emotion $DetectedEmotion `
        -Success $true

    Save-SimpleMemory -Memory $memory
}
```

### æ­¥éª¤3: æµ‹è¯•éªŒè¯ï¼ˆ5åˆ†é’Ÿï¼‰

åˆ›å»ºæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š

**æ–‡ä»¶**: `H:\HZH\Little-Projects\voice-notification-project\tests\Test-SimpleMemory.ps1`

```powershell
#Requires -Version 5.1

<#
.SYNOPSIS
    Test script for SimpleMemory module
    SimpleMemory æ¨¡å—æµ‹è¯•è„šæœ¬
#>

param()

# åŠ è½½æ¨¡å—
$modulePath = Join-Path $PSScriptRoot '..\modules\SimpleMemory.psm1'
Import-Module $modulePath -Force

Write-Host "=== SimpleMemory Module Test ===" -ForegroundColor Cyan

# Test 1: åˆå§‹åŒ–è®°å¿†
Write-Host "`n[Test 1] Initializing memory..." -ForegroundColor Yellow
$memory = Initialize-SimpleMemory -WindowSize 10
Write-Host "âœ“ Memory initialized: $($memory.interactions.Count) interactions" -ForegroundColor Green

# Test 2: æ·»åŠ äº¤äº’
Write-Host "`n[Test 2] Adding interactions..." -ForegroundColor Yellow
$testData = @(
    @{User="åˆ›å»ºç”¨æˆ·æ‰‹å†Œ"; Summary="å…ˆç”Ÿ,æ–‡æ¡£å·²åˆ›å»ºå®Œæˆ"; Emotion="calm"},
    @{User="ä¿®å¤ç™»å½•Bug"; Summary="ç™»å½•é—®é¢˜å·²ä¿®å¤"; Emotion="celebrate"},
    @{User="ä¼˜åŒ–ä»£ç æ€§èƒ½"; Summary="ä»£ç ä¼˜åŒ–å®Œæˆ,æ€§èƒ½æå‡50%"; Emotion="calm"},
    @{User="åˆ›å»ºAPIæ–‡æ¡£"; Summary="å…ˆç”Ÿ,APIæ–‡æ¡£å·²ç”Ÿæˆ"; Emotion="calm"},
    @{User="å¤„ç†é”™è¯¯æŠ¥å‘Š"; Summary="é”™è¯¯å·²è®°å½•å¹¶ä¿®å¤"; Emotion="error"}
)

foreach ($data in $testData) {
    $memory = Add-SimpleMemory -Memory $memory `
        -UserMessage $data.User `
        -AiSummary $data.Summary `
        -Emotion $data.Emotion
}

Write-Host "âœ“ Added $($testData.Count) interactions" -ForegroundColor Green

# Test 3: å…³é”®è¯æå–
Write-Host "`n[Test 3] Extracting keywords..." -ForegroundColor Yellow
$keywords = Extract-SimpleKeywords -Text "åˆ›å»ºç”¨æˆ·æ‰‹å†Œå’ŒAPIæ–‡æ¡£"
Write-Host "Keywords: $($keywords -join ', ')" -ForegroundColor White

# Test 4: ä¸Šä¸‹æ–‡æœç´¢
Write-Host "`n[Test 4] Finding similar context..." -ForegroundColor Yellow
$context = Find-SimpleContext -Memory $memory -QueryText "ç”Ÿæˆæ–‡æ¡£" -TopN 2
Write-Host "âœ“ Found $($context.Count) similar interactions:" -ForegroundColor Green
foreach ($item in $context) {
    Write-Host "  - $($item.user_message)" -ForegroundColor White
}

# Test 5: ç”Ÿæˆè‡ªé€‚åº”æç¤ºè¯
Write-Host "`n[Test 5] Generating adaptive prompt..." -ForegroundColor Yellow
$prompt = Get-SimpleAdaptivePrompt -Memory $memory -CurrentMessage "åˆ›å»ºæŠ€æœ¯æ–‡æ¡£"
Write-Host "âœ“ Prompt generated (length: $($prompt.Length) chars)" -ForegroundColor Green
Write-Host "`nPrompt preview:" -ForegroundColor Cyan
Write-Host $prompt.Substring(0, [math]::Min(200, $prompt.Length)) -ForegroundColor White
Write-Host "..." -ForegroundColor White

# Test 6: ç»Ÿè®¡åˆ†æ
Write-Host "`n[Test 6] Memory statistics..." -ForegroundColor Yellow
$stats = Get-MemoryStatistics -Memory $memory

Write-Host "`nTotal Interactions: $($stats.TotalInteractions)" -ForegroundColor White
Write-Host "Success Rate: $($stats.SuccessRate)%" -ForegroundColor White

Write-Host "`nTop Emotions:" -ForegroundColor Cyan
$stats.TopEmotions | ForEach-Object {
    Write-Host "  $($_.Emotion): $($_.Count)" -ForegroundColor White
}

Write-Host "`nTop Keywords:" -ForegroundColor Cyan
$stats.TopKeywords | Select-Object -First 5 | ForEach-Object {
    Write-Host "  $($_.Keyword): $($_.Count)" -ForegroundColor White
}

# Test 7: ä¿å­˜è®°å¿†
Write-Host "`n[Test 7] Saving memory..." -ForegroundColor Yellow
$testPath = Join-Path $PSScriptRoot '..\data\test-memory.json'
Save-SimpleMemory -Memory $memory -Path $testPath

if (Test-Path $testPath) {
    $fileSize = (Get-Item $testPath).Length
    Write-Host "âœ“ Memory saved to $testPath ($fileSize bytes)" -ForegroundColor Green
}

# Test 8: æ»‘åŠ¨çª—å£æµ‹è¯•
Write-Host "`n[Test 8] Testing sliding window (limit=10)..." -ForegroundColor Yellow
for ($i = 1; $i -le 15; $i++) {
    $memory = Add-SimpleMemory -Memory $memory `
        -UserMessage "Test message $i" `
        -AiSummary "Summary $i" `
        -Emotion "calm"
}

Write-Host "âœ“ After adding 15 more, kept last 10: $($memory.interactions.Count) interactions" -ForegroundColor Green

Write-Host "`n=== All Tests Completed ===" -ForegroundColor Cyan
```

è¿è¡Œæµ‹è¯•ï¼š

```powershell
# è¿›å…¥é¡¹ç›®ç›®å½•
cd H:\HZH\Little-Projects\voice-notification-project

# è¿è¡Œæµ‹è¯•
.\tests\Test-SimpleMemory.ps1
```

---

## ğŸ“Š æ•ˆæœéªŒè¯

### 1. æŸ¥çœ‹è®°å¿†æ–‡ä»¶

```powershell
# æŸ¥çœ‹å®Œæ•´è®°å¿†å†…å®¹
Get-Content .\data\simple-memory.json | ConvertFrom-Json | ConvertTo-Json -Depth 10

# æŸ¥çœ‹äº¤äº’æ•°é‡
$memory = Get-Content .\data\simple-memory.json | ConvertFrom-Json
Write-Host "æ€»äº¤äº’æ•°: $($memory.interactions.Count)"

# æŸ¥çœ‹æœ€è¿‘3æ¡äº¤äº’
$memory.interactions | Select-Object -Last 3 | Format-Table user_message, emotion, keywords -AutoSize
```

### 2. æŸ¥çœ‹åå¥½ç»Ÿè®¡

```powershell
# åŠ è½½è®°å¿†
$memory = Get-Content .\data\simple-memory.json -Raw | ConvertFrom-Json

# æƒ…æ„Ÿåå¥½
Write-Host "`n=== æƒ…æ„Ÿåå¥½ç»Ÿè®¡ ===" -ForegroundColor Cyan
$memory.preferences.emotion_counts.PSObject.Properties |
    Sort-Object -Property Value -Descending |
    ForEach-Object {
        Write-Host "$($_.Name): $($_.Value)" -ForegroundColor White
    }

# å…³é”®è¯é¢‘ç‡
Write-Host "`n=== å¸¸ç”¨å…³é”®è¯ï¼ˆTop 10ï¼‰ ===" -ForegroundColor Cyan
$memory.preferences.common_keywords.PSObject.Properties |
    Sort-Object -Property Value -Descending |
    Select-Object -First 10 |
    ForEach-Object {
        Write-Host "$($_.Name): $($_.Value)" -ForegroundColor White
    }
```

### 3. å¯¹æ¯”æµ‹è¯•æ•ˆæœ

**æµ‹è¯•åœºæ™¯**: è¿ç»­3æ¬¡åˆ›å»ºæ–‡æ¡£ç±»ä»»åŠ¡

```powershell
# ç¬¬1æ¬¡ï¼ˆæ— å†å²ä¸Šä¸‹æ–‡ï¼‰
# æ’­æŠ¥: "å…ˆç”Ÿ,æ–‡æ¡£å·²åˆ›å»ºå®Œæˆ"

# ç¬¬2æ¬¡ï¼ˆæœ‰1æ¡å†å²ï¼‰
# æ’­æŠ¥: "å…ˆç”Ÿ,æ–‡æ¡£å·²åˆ›å»ºå®Œæˆï¼ŒåŒ…å«XXç« èŠ‚"ï¼ˆå¼€å§‹æœ‰å˜åŒ–ï¼‰

# ç¬¬3æ¬¡ï¼ˆæœ‰2æ¡å†å²ï¼‰
# æ’­æŠ¥: "å…ˆç”Ÿ,æŠ€æœ¯æ–‡æ¡£ç”Ÿæˆå®Œæ¯•"ï¼ˆé£æ ¼å¼€å§‹ä¸ªæ€§åŒ–ï¼‰
```

---

## ğŸ”§ é«˜çº§é…ç½®

### è°ƒæ•´æ»‘åŠ¨çª—å£å¤§å°

æ ¹æ®ä½¿ç”¨é¢‘ç‡è°ƒæ•´ä¿ç•™çš„å†å²æ•°é‡ï¼š

```powershell
# ä½é¢‘ä½¿ç”¨ï¼ˆæ¯å¤©1-2æ¬¡ï¼‰- ä¿ç•™100æ¡ï¼ˆçº¦3ä¸ªæœˆï¼‰
$memory = Initialize-SimpleMemory -WindowSize 100

# ä¸­é¢‘ä½¿ç”¨ï¼ˆæ¯å¤©5-10æ¬¡ï¼‰- ä¿ç•™500æ¡ï¼ˆçº¦2ä¸ªæœˆï¼‰
$memory = Initialize-SimpleMemory -WindowSize 500

# é«˜é¢‘ä½¿ç”¨ï¼ˆæ¯å¤©20+æ¬¡ï¼‰- ä¿ç•™1000æ¡ï¼ˆçº¦2ä¸ªæœˆï¼‰
$memory = Initialize-SimpleMemory -WindowSize 1000
```

### å…³é”®è¯æå–ä¼˜åŒ–

ä¿®æ”¹ `Extract-SimpleKeywords` å‡½æ•°ï¼Œæ·»åŠ è‡ªå®šä¹‰è§„åˆ™ï¼š

```powershell
# åœ¨å‡½æ•°ä¸­æ·»åŠ ç‰¹å®šé¢†åŸŸè¯æ±‡
$domainKeywords = @("æ–‡æ¡£", "Bug", "ä¼˜åŒ–", "éƒ¨ç½²", "æµ‹è¯•")

# ä¼˜å…ˆæå–é¢†åŸŸå…³é”®è¯
foreach ($kw in $domainKeywords) {
    if ($Text -match $kw) {
        $allKeywords += $kw
    }
}
```

### æƒ…æ„Ÿåå¥½æƒé‡

åœ¨ `Get-SimpleAdaptivePrompt` ä¸­æ ¹æ®é¢‘ç‡è°ƒæ•´æƒé‡ï¼š

```powershell
# è·å–æƒ…æ„Ÿåˆ†å¸ƒ
$emotionTotal = ($memory.preferences.emotion_counts.PSObject.Properties.Value | Measure-Object -Sum).Sum
$emotionDistribution = $memory.preferences.emotion_counts.PSObject.Properties | ForEach-Object {
    "$($_.Name) ($([math]::Round($_.Value/$emotionTotal*100, 1))%)"
}

# æ·»åŠ åˆ°æç¤ºè¯
"ã€æƒ…æ„Ÿåˆ†å¸ƒã€‘`n$($emotionDistribution -join ', ')"
```

---

## ğŸ“ˆ æ¼”è¿›è®¡åˆ’

### ç¬¬1ä¸ªæœˆ: æ•°æ®ç§¯ç´¯æœŸ
- **ç›®æ ‡**: ç´¯ç§¯ 50+ æ¡äº¤äº’æ•°æ®
- **è§‚å¯Ÿ**: å…³é”®è¯å’Œæƒ…æ„Ÿåˆ†å¸ƒæ˜¯å¦å‡è¡¡
- **è°ƒæ•´**: å¿…è¦æ—¶æ‰©å±•å…³é”®è¯æå–è§„åˆ™

### ç¬¬2-3ä¸ªæœˆ: æ•ˆæœéªŒè¯æœŸ
- **ç›®æ ‡**: ç´¯ç§¯ 150+ æ¡æ•°æ®
- **éªŒè¯**: ä¸Šä¸‹æ–‡åŒ¹é…æ˜¯å¦å¼€å§‹ç”Ÿæ•ˆ
- **å¯¹æ¯”**: æœ‰æ— å†å²ä¸Šä¸‹æ–‡çš„æ’­æŠ¥è´¨é‡å·®å¼‚

### ç¬¬4-6ä¸ªæœˆ: ä¼˜åŒ–æœŸ
- **ç›®æ ‡**: ç´¯ç§¯ 500+ æ¡æ•°æ®
- **ä¼˜åŒ–**: è°ƒæ•´æç¤ºè¯æ¨¡æ¿å’ŒåŒ¹é…ç®—æ³•
- **è¯„ä¼°**: æ˜¯å¦éœ€è¦å‡çº§åˆ°æ–¹æ¡ˆ1ï¼ˆSQLite-vec RAGï¼‰

---

## ğŸš¨ å¸¸è§é—®é¢˜

### Q1: è®°å¿†æ–‡ä»¶è¿‡å¤§æ€ä¹ˆåŠ?

**A**: æ»‘åŠ¨çª—å£ä¼šè‡ªåŠ¨æ¸…ç†ï¼Œä½†å¦‚æœéœ€è¦æ‰‹åŠ¨å‹ç¼©ï¼š

```powershell
# æ‰‹åŠ¨æ¸…ç†ï¼Œåªä¿ç•™æœ€è¿‘50æ¡
$memory = Get-Content .\data\simple-memory.json -Raw | ConvertFrom-Json
$memory.interactions = $memory.interactions | Select-Object -Last 50
$memory | ConvertTo-Json -Depth 10 | Set-Content .\data\simple-memory.json -Encoding UTF8
```

### Q2: å…³é”®è¯æå–ä¸å‡†ç¡®?

**A**: æ·»åŠ è‡ªå®šä¹‰å…³é”®è¯è§„åˆ™ï¼š

```powershell
# åœ¨ Extract-SimpleKeywords ä¸­æ·»åŠ 
$customPatterns = @(
    'åˆ›å»º\w+',    # åˆ›å»ºXX
    'ä¿®å¤\w+',    # ä¿®å¤XX
    'ä¼˜åŒ–\w+'     # ä¼˜åŒ–XX
)
```

### Q3: ä¸Šä¸‹æ–‡åŒ¹é…ä¸ç›¸å…³?

**A**: è°ƒæ•´åŒ¹é…é˜ˆå€¼ï¼š

```powershell
# åœ¨ Find-SimpleContext ä¸­
if ($matchCount -gt 0 -and $matchCount / $queryKeywords.Count -gt 0.5) {
    # åªä¿ç•™åŒ¹é…ç‡ > 50% çš„ç»“æœ
}
```

### Q4: å¦‚ä½•æ¸…ç©ºè®°å¿†é‡æ–°å¼€å§‹?

**A**: åˆ é™¤è®°å¿†æ–‡ä»¶æˆ–é‡æ–°åˆå§‹åŒ–ï¼š

```powershell
# æ–¹æ³•1: åˆ é™¤æ–‡ä»¶
Remove-Item .\data\simple-memory.json

# æ–¹æ³•2: å¤‡ä»½åé‡æ–°åˆå§‹åŒ–
Move-Item .\data\simple-memory.json .\data\simple-memory.backup.json
$memory = Initialize-SimpleMemory
Save-SimpleMemory -Memory $memory
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨ï¼ˆä»Šå¤©ï¼‰
1. âœ… å¤åˆ¶ `SimpleMemory.psm1` åˆ° `modules` ç›®å½•
2. âœ… è¿è¡Œ `Test-SimpleMemory.ps1` éªŒè¯åŠŸèƒ½
3. âœ… é›†æˆåˆ°ä¸»è„šæœ¬ `voice-notification.ps1`

### æœ¬å‘¨å®Œæˆ
1. âœ… ä½¿ç”¨3-5å¤©ï¼Œç§¯ç´¯åˆå§‹æ•°æ®
2. âœ… è§‚å¯Ÿè®°å¿†æ–‡ä»¶çš„å¢é•¿å’Œç»Ÿè®¡å˜åŒ–
3. âœ… éªŒè¯ä¸Šä¸‹æ–‡åŒ¹é…æ˜¯å¦ç”Ÿæ•ˆ

### ä¸‹ä¸ªæœˆ
1. âœ… åˆ†æ `simple-memory.json` çš„åå¥½ç»Ÿè®¡
2. âœ… æ ¹æ®å®é™…ä½¿ç”¨è°ƒæ•´å‚æ•°ï¼ˆçª—å£å¤§å°ã€å…³é”®è¯è§„åˆ™ï¼‰
3. âœ… è¯„ä¼°æ˜¯å¦éœ€è¦å‡çº§åˆ°æ–¹æ¡ˆ1ï¼ˆSQLite-vec RAGï¼‰

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**
   ```powershell
   Get-Content .\logs\voice-unified.log -Tail 50
   ```

2. **æ£€æŸ¥è®°å¿†æ–‡ä»¶**
   ```powershell
   Get-Content .\data\simple-memory.json | ConvertFrom-Json
   ```

3. **è¿è¡Œæµ‹è¯•è„šæœ¬**
   ```powershell
   .\tests\Test-SimpleMemory.ps1
   ```

4. **æŸ¥çœ‹æ¨¡å—å¸®åŠ©**
   ```powershell
   Get-Help Initialize-SimpleMemory -Full
   ```

---

**ç¥æ‚¨çš„è¯­éŸ³é€šçŸ¥ç³»ç»Ÿå¼€å§‹è‡ªæˆ‘è¿›åŒ–ä¹‹æ—…ï¼** ğŸš€

---

**é™„å½•: å®Œæ•´é›†æˆç¤ºä¾‹**

```powershell
# voice-notification.ps1 é›†æˆç¤ºä¾‹ï¼ˆå®Œæ•´æµç¨‹ï¼‰

# 1. æ¨¡å—åŠ è½½åŒº
Import-Module (Join-Path $PSScriptRoot '..\modules\SimpleMemory.psm1') -Force

# 2. åˆå§‹åŒ–è®°å¿†
$memory = Initialize-SimpleMemory

# 3. æå–ç”¨æˆ·æ¶ˆæ¯
$UserMessage = Extract-LastUserMessage  # æ‚¨ç°æœ‰çš„å‡½æ•°

# 4. ç”Ÿæˆè‡ªé€‚åº”æç¤ºè¯
$adaptivePrompt = Get-SimpleAdaptivePrompt -Memory $memory -CurrentMessage $UserMessage

# 5. è°ƒç”¨ Ollama ç”Ÿæˆæ€»ç»“
$AiSummary = Invoke-OllamaGenerate -Prompt $adaptivePrompt

# 6. æ£€æµ‹æƒ…æ„Ÿ
$EmotionStyle = Get-EmotionStyle -UserMessage $UserMessage -ClaudeReply $ClaudeReply

# 7. æ’­æ”¾è¯­éŸ³
Invoke-PlayAudio -Text $AiSummary -EmotionStyle $EmotionStyle

# 8. ä¿å­˜åˆ°è®°å¿†
$memory = Add-SimpleMemory -Memory $memory `
    -UserMessage $UserMessage `
    -AiSummary $AiSummary `
    -Emotion $EmotionStyle `
    -Success $true

Save-SimpleMemory -Memory $memory

# 9. è®°å½•æ—¥å¿—
Write-UnifiedLog -Message "Memory saved: $($memory.interactions.Count) total interactions" -Level "INFO"
```
