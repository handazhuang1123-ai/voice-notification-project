/**
 * OllamaService - Phase 2.1 ä¸ªäººç”»åƒé—®å·ç³»ç»Ÿ
 * è´Ÿè´£ä¸ Ollama API äº¤äº’ï¼Œæä¾›å„é˜¶æ®µçš„ AI å¯¹è¯èƒ½åŠ›
 *
 * Author: å£®çˆ¸
 * Date: 2025-11-24
 * Version: 2.0.0 (TypeScript)
 */

import axios from 'axios';
import { getConfig } from '../config.js';

/**
 * Session interface for building prompts
 * æ„å»ºæç¤ºè¯çš„ä¼šè¯æ¥å£
 */
interface SessionInfo {
    question_text: string;
    initial_answer: string;
}

/**
 * Conversation message interface
 * å¯¹è¯æ¶ˆæ¯æ¥å£
 */
interface ConversationMessage {
    role: 'ai' | 'user';
    content: string;
    phase?: string;
    timestamp?: string;
}

/**
 * Generate options interface
 * ç”Ÿæˆé€‰é¡¹æ¥å£
 */
interface GenerateOptions {
    temperature?: number;
    top_p?: number;
    num_ctx?: number;
    num_predict?: number;
}

export class OllamaService {
    public model: string;
    private ollamaUrl: string;

    /**
     * æ„é€ å‡½æ•°
     * @param model - ä½¿ç”¨çš„æ¨¡å‹ï¼Œé»˜è®¤ä»é…ç½®è¯»å–
     * @param ollamaUrl - Ollama API URL
     */
    constructor(model?: string, ollamaUrl?: string) {
        const config = getConfig();
        this.model = model || config.models.default;
        this.ollamaUrl = ollamaUrl || config.ollama.url;
        console.log(`ğŸ¤– OllamaService åˆå§‹åŒ– - æ¨¡å‹: ${this.model}`);
    }

    /**
     * ç”Ÿæˆæ–‡æœ¬å“åº”
     * @param prompt - æç¤ºè¯
     * @param options - ç”Ÿæˆé€‰é¡¹
     * @returns ç”Ÿæˆçš„æ–‡æœ¬
     */
    async generate(prompt: string, options: GenerateOptions = {}): Promise<string> {
        const config = getConfig();

        try {
            console.log(`ğŸ“ æ­£åœ¨è°ƒç”¨æ¨¡å‹ ${this.model}...`);

            const response = await axios.post(`${this.ollamaUrl}/api/generate`, {
                model: this.model,
                prompt: prompt,
                stream: false,
                format: 'json',
                options: {
                    temperature: options.temperature || config.ollama.options.temperature,
                    top_p: options.top_p || config.ollama.options.top_p,
                    num_ctx: options.num_ctx || config.ollama.options.num_ctx,
                    num_predict: options.num_predict || config.ollama.options.num_predict
                }
            });

            return response.data.response;
        } catch (error) {
            const err = error as Error & { response?: { data: unknown } };
            console.error('âŒ Ollama ç”Ÿæˆå¤±è´¥:', err.message);
            if (err.response) {
                console.error('é”™è¯¯è¯¦æƒ…:', err.response.data);
            }
            throw error;
        }
    }

    /**
     * æ„å»ºé˜¶æ®µæç¤ºè¯
     * @param phase - å½“å‰é˜¶æ®µ
     * @param session - ä¼šè¯ä¿¡æ¯
     * @param conversationHistory - å¯¹è¯å†å²
     * @returns æ„å»ºçš„æç¤ºè¯
     */
    buildPhasePrompt(
        phase: string,
        session: SessionInfo,
        conversationHistory: ConversationMessage[]
    ): string {
        console.log('ğŸ” æ„å»ºæç¤ºè¯ - é˜¶æ®µ:', phase);
        console.log('ğŸ” å¯¹è¯å†å²æ¡æ•°:', conversationHistory.length);
        console.log('ğŸ” å¯¹è¯å†å²å†…å®¹:', conversationHistory.map(c => `[${c.role}] ${c.content.substring(0, 50)}...`).join('\n'));

        const baseContext = `
é—®é¢˜: ${session.question_text}
ç”¨æˆ·åˆå§‹å›ç­”: ${session.initial_answer}

å¯¹è¯å†å²:
${conversationHistory.map(c => `${c.role === 'ai' ? 'ğŸ¤– AI' : 'ğŸ‘¤ ç”¨æˆ·'}: ${c.content}`).join('\n')}
`;

        console.log('ğŸ“‹ åŸºç¡€ä¸Šä¸‹æ–‡é•¿åº¦:', baseContext.length);

        switch (phase) {
            case 'opening':
                return this.buildOpeningPrompt(baseContext);
            case 'narrative':
                return this.buildNarrativePrompt(baseContext);
            case 'grow':
                return this.buildGrowPrompt(baseContext);
            case 'values':
                return this.buildValuesPrompt(baseContext);
            case 'summary':
                return this.buildSummaryPrompt(baseContext);
            default:
                throw new Error(`æœªçŸ¥çš„é˜¶æ®µ: ${phase}`);
        }
    }

    /**
     * å¼€åœºç ´å†°é˜¶æ®µæç¤ºè¯
     */
    private buildOpeningPrompt(context: string): string {
        return `ä½ æ˜¯ä¸€ä½æ¸©æš–ã€å¯Œæœ‰åŒç†å¿ƒçš„è®¿è°ˆè€…ï¼Œæ­£åœ¨è¿›è¡Œå¼€åœºç ´å†°ã€‚

${context}

ä½ çš„ä»»åŠ¡ï¼š
1. è¥é€ å®‰å…¨ã€è½»æ¾çš„å¯¹è¯æ°›å›´
2. å»ºç«‹ä¿¡ä»»å…³ç³»
3. è®©ç”¨æˆ·æ„Ÿåˆ°è¢«å€¾å¬å’Œç†è§£
4. è‡ªç„¶è¿‡æ¸¡åˆ°æ·±åº¦å¯¹è¯

è®¿è°ˆæŠ€å·§ï¼š
- ä½¿ç”¨æ¸©æš–ã€å‹å¥½çš„è¯­è¨€
- å±•ç°çœŸè¯šçš„å¥½å¥‡å¿ƒ
- é¿å…çªå…€çš„æ·±å…¥è¿½é—®
- å…è®¸æ²‰é»˜å’Œåœé¡¿
- ç”¨è½»æ¾çš„è¯é¢˜å¼€å§‹

è¾“å‡ºä¸¥æ ¼çš„ JSON æ ¼å¼ï¼š
{
  "question": "ä½ çš„è¿½é—®ï¼ˆæ¸©æš–ã€å¼€æ”¾çš„é—®é¢˜ï¼‰",
  "dice_type": "opening",
  "reasoning": "ä¸ºä»€ä¹ˆé—®è¿™ä¸ªï¼ˆä¸è¶…è¿‡50å­—ï¼‰",
  "should_continue": trueæˆ–false,
  "next_phase": nullæˆ–"narrative"
}

## ç»“æŸç ´å†°çš„é‡åŒ–æ ‡å‡†ï¼ˆåŸºäºè®¿è°ˆç ”ç©¶æ–‡çŒ®ï¼‰

### æœ€ä½è¦æ±‚ï¼ˆå¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼‰ï¼š
1. âœ… å¯¹è¯è½®æ•° â‰¥ 3è½®ï¼ˆå½“å‰å·²è®¡æ•°ï¼‰
2. âœ… è‡³å°‘1æ¬¡ç”¨æˆ·å›ç­” > 50å­—ç¬¦
3. âœ… è·å¾—åŸºæœ¬ä¿¡æ¯ï¼ˆç§°å‘¼æ–¹å¼ã€å…³æ³¨è¯é¢˜ï¼‰

### ç†æƒ³æ ‡å‡†ï¼ˆæ»¡è¶³2/3å³è½¬æ¢ï¼‰ï¼š
- **ä¿¡ä»»å»ºç«‹**ï¼šç”¨æˆ·å¼€å§‹åˆ†äº«å…·ä½“ç»†èŠ‚ã€è´Ÿé¢æƒ…ç»ªæˆ–è„†å¼±æ—¶åˆ»
- **å™äº‹èŒèŠ½**ï¼šç”¨æˆ·æåŠå…·ä½“äº‹ä»¶ï¼ˆ"é‚£æ—¶å€™"ã€"æœ‰ä¸€æ¬¡"ã€å…·ä½“æ—¶é—´/åœ°ç‚¹/äººç‰©ï¼‰
- **æƒ…ç»ªå‚ä¸**ï¼šç”¨æˆ·ä½¿ç”¨æƒ…ç»ªè¯æ±‡ï¼ˆç„¦è™‘ã€å…´å¥‹ã€å¤±æœ›ã€æ„¤æ€’ç­‰æ„Ÿå—ï¼‰

### å¼ºåˆ¶è½¬æ¢ä¿¡å·ï¼ˆå‡ºç°ä»»ä¸€å³ç«‹å³è½¬æ¢ï¼‰ï¼š
- ç”¨æˆ·è¿ç»­2æ¬¡å›ç­” > 150å­—ç¬¦ä¸”åŒ…å«å…·ä½“äº‹ä¾‹
- ç”¨æˆ·ä¸»åŠ¨å±•ç°æ·±åº¦æ€è€ƒï¼ˆç³»ç»Ÿæ€§åˆ†æã€éšå–»ã€å› æœæ¨ç†ï¼‰
- ç”¨æˆ·ä¸»åŠ¨åˆ†äº«é‡è¦äººç”Ÿäº‹ä»¶æˆ–è½¬æŠ˜ç‚¹

### ç¦æ­¢è½¬æ¢ï¼ˆå‡ºç°åˆ™ç»§ç»­ç ´å†°ï¼‰ï¼š
- ç”¨æˆ·æŒç»­ç»™å‡º < 15å­—ç¬¦çš„ç®€çŸ­å›ç­”
- ç”¨æˆ·è¡¨ç°å‡ºæŠ—æ‹’æˆ–è¦æ±‚æ¢è¯é¢˜

**å†³ç­–æŒ‡ä»¤**ï¼š
- å½“å¯¹è¯â‰¥3è½® ä¸” æ»¡è¶³2ä¸ªç†æƒ³æ ‡å‡† æˆ– 1ä¸ªå¼ºåˆ¶è½¬æ¢ä¿¡å·æ—¶ï¼Œç«‹å³è®¾ç½® should_continue=false, next_phase="narrative"
- å½“å¯¹è¯â‰¥5è½®æ—¶ï¼Œæ— è®ºå¦‚ä½•éƒ½åº”è½¬æ¢ï¼ˆé¿å…è¿‡åº¦ç ´å†°ï¼‰`;
    }

    /**
     * å™äº‹æ¢ç´¢é˜¶æ®µæç¤ºè¯
     */
    private buildNarrativePrompt(context: string): string {
        return `ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„è®¿è°ˆè€…ï¼Œæ­£åœ¨è¿›è¡Œå™äº‹æ¢ç´¢é˜¶æ®µï¼ˆä½¿ç”¨DICEæŠ€æœ¯ï¼‰ã€‚

${context}

## DICEè¿½é—®æŠ€æœ¯çš„ä½¿ç”¨é¡ºåºï¼ˆåŸºäºç ”ç©¶æ–‡çŒ®ï¼‰

### ç¬¬ä¸€é˜¶æ®µï¼ˆæ—©æœŸï¼‰- D & I æ¢è¯¢ï¼š
- **D (Descriptive)**: æè¿°æ€§ç»†èŠ‚è¿½é—®ï¼ˆæ—¶é—´ã€åœ°ç‚¹ã€äººç‰©ã€æ„Ÿå®˜ç»†èŠ‚ï¼‰
- **I (Idiographic)**: ä¹ æƒ¯æ€§è®°å¿†è¿½é—®ï¼ˆä»ä¸€èˆ¬æ€§è®°å¿†è½¬å‘å…·ä½“è®°å¿†ï¼‰

### ç¬¬äºŒé˜¶æ®µï¼ˆåæœŸï¼‰- C & E æ¢è¯¢ï¼š
- **C (Clarifying)**: æ¾„æ¸…æ€§è¿½é—®ï¼ˆæ•æ„Ÿä¿¡æ¯ã€éšè—ç»†èŠ‚ã€æ¨¡ç³Šæ¦‚å¿µï¼‰
- **E (Explanatory)**: è§£é‡Šæ€§æ¢è¯¢ï¼ˆå› æœå…³ç³»ã€ä¸ªäººæ„ä¹‰ã€æ·±å±‚åŠ¨æœºï¼‰

## è´¨é‡è¦æ±‚ï¼š
- æ¯æ¬¡åªé—®ä¸€ä¸ªå¼€æ”¾æ€§é—®é¢˜
- é¿å…æ˜¯/å¦é—®é¢˜
- å……åˆ†ç»“åˆç”¨æˆ·å·²ç»™å‡ºçš„å›ç­”ï¼Œé¿å…é‡å¤æé—®
- æ·±æŒ–å…·ä½“ç»†èŠ‚è€Œéåœç•™åœ¨è¡¨é¢

## ç»“æŸå™äº‹é˜¶æ®µçš„é‡åŒ–æ ‡å‡†

### æœ€ä½è¦æ±‚ï¼ˆå…¨éƒ¨æ»¡è¶³ï¼‰ï¼š
- âœ… å¯¹è¯è½®æ•° â‰¥ 12è½®ï¼ˆè®¡å…¥å½“å‰è½®ï¼‰
- âœ… è‡³å°‘å®Œæˆ 2ä¸ªå…·ä½“äº‹ä»¶çš„ D/I æ¢è¯¢
- âœ… è‡³å°‘å®Œæˆ 3æ¬¡ C/E æ·±åº¦æ¢è¯¢

### ç¼–ç é¥±å’Œæ ‡å‡†ï¼š
- **è¿ç»­3è½®å¯¹è¯æœªå‡ºç°æ–°ä¸»é¢˜**ï¼ˆå·²å……åˆ†è¦†ç›–ç”¨æˆ·çš„å…³é”®ç»å†ï¼‰

### æ„ä¹‰é¥±å’Œæ ‡å‡†ï¼ˆæ»¡è¶³2/3å³å¯ï¼‰ï¼š
- **æ´å¯Ÿå‡ºç°**ï¼šç”¨æˆ·ä½¿ç”¨"æˆ‘æ„è¯†åˆ°"ã€"æˆ‘å‘ç°"ã€"åŸæ¥æ˜¯å› ä¸º"ç­‰å…ƒè®¤çŸ¥è¯æ±‡
- **å› æœé“¾æ¡**ï¼šç”¨æˆ·èƒ½å¤Ÿè§£é‡Šäº‹ä»¶ä¹‹é—´çš„å› æœå…³ç³»ï¼ˆAå¯¼è‡´Bï¼Œå› ä¸ºCï¼‰
- **æƒ…ç»ªæ„ä¹‰åŒ–**ï¼šç”¨æˆ·ä¸ä»…æè¿°æƒ…ç»ªï¼Œè¿˜èƒ½è§£é‡Šæƒ…ç»ªçš„æ¥æºå’Œå½±å“

### å¼ºåˆ¶è½¬æ¢ä¿¡å·ï¼ˆå‡ºç°å³è½¬æ¢ï¼‰ï¼š
- å¯¹è¯â‰¥15è½®ä¸”ç”¨æˆ·å·²å¤šæ¬¡è¡¨è¾¾æ·±å±‚æ´å¯Ÿ
- ç”¨æˆ·ä¸»åŠ¨è¡¨ç¤º"æˆ‘è§‰å¾—å·²ç»å¾ˆæ¸…æ¥šäº†"

è¾“å‡ºä¸¥æ ¼çš„ JSON æ ¼å¼ï¼š
{
  "question": "ä½ çš„è¿½é—®ï¼ˆä¸€ä¸ªå¼€æ”¾æ€§é—®é¢˜ï¼‰",
  "dice_type": "descriptiveæˆ–idiographicæˆ–clarifyingæˆ–explanatory",
  "reasoning": "ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªè¿½é—®ï¼ˆä¸è¶…è¿‡50å­—ï¼‰",
  "should_continue": trueæˆ–false,
  "next_phase": nullæˆ–"grow"
}

**å†³ç­–æŒ‡ä»¤**ï¼š
- å½“å¯¹è¯â‰¥12è½® ä¸” å®ŒæˆDICEå®Œæ•´æ€§ ä¸” è¾¾åˆ°ç¼–ç é¥±å’Œ ä¸” æ»¡è¶³2ä¸ªæ„ä¹‰é¥±å’Œæ ‡å‡†æ—¶ï¼Œè®¾ç½® should_continue=false, next_phase="grow"`;
    }

    /**
     * GROW ç»“æ„åŒ–é˜¶æ®µæç¤ºè¯
     */
    private buildGrowPrompt(context: string): string {
        return `ä½ æ˜¯ä¸€ä½ä¸“ä¸šæ•™ç»ƒï¼Œæ­£åœ¨ä½¿ç”¨ GROW æ¨¡å‹è¿›è¡Œç»“æ„åŒ–è®¿è°ˆã€‚

${context}

## GROW å››ä¸ªå­é˜¶æ®µåŠå®Œæˆæ ‡å‡†ï¼ˆåŸºäºæ•™ç»ƒç ”ç©¶ï¼‰

### 1. Goalï¼ˆç›®æ ‡è®¾å®šï¼‰- çº¦3-5è½®å¯¹è¯
**å®Œæˆæ ‡å‡†**ï¼š
- ç”¨æˆ·æ˜ç¡®è¡¨è¾¾ 1-3ä¸ªå…·ä½“ç›®æ ‡
- ç›®æ ‡ç¬¦åˆSMARTåŸåˆ™ï¼ˆå…·ä½“ã€å¯è¡¡é‡ã€æœ‰æ—¶é™ï¼‰
- åŒºåˆ†çŸ­æœŸç›®æ ‡ï¼ˆ1-3ä¸ªæœˆï¼‰å’Œé•¿æœŸç›®æ ‡ï¼ˆ6-12ä¸ªæœˆï¼‰
- ç”¨æˆ·å¯¹ç›®æ ‡çš„é‡è¦æ€§è¯„åˆ† â‰¥ 7/10

**å…³é”®é—®é¢˜**ï¼š"ä½ å¸Œæœ›å®ç°ä»€ä¹ˆï¼Ÿ"ã€"ç†æƒ³çŠ¶æ€æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"ã€"è¿™å¯¹ä½ ä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ"

### 2. Realityï¼ˆç°å®è¯„ä¼°ï¼‰- çº¦6-8è½®å¯¹è¯ï¼ˆæœ€é‡è¦ï¼‰
**å®Œæˆæ ‡å‡†**ï¼š
- ç”¨æˆ·åˆ—ä¸¾ â‰¥ 3ä¸ªå½“å‰ç°å®çš„å…·ä½“è¦ç´ ï¼ˆå·²æœ‰èµ„æºã€ç¼ºå¤±èµ„æºã€å®é™…å›°éš¾ï¼‰
- **æ ¸å¿ƒï¼šå‡ºç°"å•Šå“ˆæ—¶åˆ»"** - ç”¨æˆ·è¯†åˆ«å‡ºé˜»ç¢çš„æ·±å±‚åŸå› ï¼ˆé™åˆ¶æ€§ä¿¡å¿µã€ææƒ§ã€èµ„æºç¼ºå£ï¼‰
- ç”¨æˆ·ä»å¤–éƒ¨å½’å› è½¬å‘å†…éƒ¨å½’å› ï¼ˆä»"ç¯å¢ƒä¸å…è®¸"åˆ°"æˆ‘å®³æ€•..."ï¼‰

**è¯†åˆ«ä¿¡å·**ï¼š"å…¶å®çœŸæ­£çš„é—®é¢˜æ˜¯..."ã€"æˆ‘ç°åœ¨æ‰æ„è¯†åˆ°..."ã€æƒ…ç»ªå¼ºåº¦æé«˜

###3. Optionsï¼ˆé€‰é¡¹ç”Ÿæˆä¸æ”¶æ•›ï¼‰- çº¦3-5è½®å¯¹è¯
**å®Œæˆæ ‡å‡†ï¼ˆä¸¥æ ¼ï¼‰**ï¼š
- ç”Ÿæˆ â‰¥ 3-5ä¸ªå¯è¡Œé€‰é¡¹
- **å¿…é¡»æ”¶æ•›è‡³1ä¸ªé€‰é¡¹**ï¼ˆè¿™æ˜¯å…³é”®æ ‡å‡†ï¼‰
- ç”¨æˆ·æ˜ç¡®è¯´æ˜é€‰æ‹©è¯¥é€‰é¡¹çš„ç†ç”±ï¼Œå¹¶ä¸Goalè¿æ¥

**å†³ç­–ä¿¡å·**ï¼š"æˆ‘å†³å®š..."ã€"æˆ‘æƒ³å…ˆè¯•è¯•..."ã€"è¿™ä¸ªé€‰é¡¹å¦‚ä½•å¸®åŠ©ä½ è¾¾æˆç›®æ ‡ï¼Ÿ"

### 4. Way Forwardï¼ˆè¡ŒåŠ¨æ‰¿è¯ºï¼‰- çº¦2-3è½®å¯¹è¯
**å®Œæˆæ ‡å‡†**ï¼š
- è¡ŒåŠ¨æ­¥éª¤ â‰¥ 3ä¸ªï¼Œæ¯ä¸ªåŒ…å«æ—¶é—´çº¿
- è¯†åˆ« â‰¥ 1-2ä¸ªæ½œåœ¨éšœç¢åŠåº”å¯¹ç­–ç•¥
- ç”¨æˆ·æ‰¿è¯ºå…·ä½“çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼ˆ24-48å°æ—¶å†…ï¼‰

**CATæ‰¿è¯ºä¿¡å·ï¼ˆè‡³å°‘2é¡¹ï¼‰**ï¼š
- Commitment: "æˆ‘æ‰¿è¯º..."ã€"æˆ‘ä¼š..."
- Activation: "æˆ‘å‡†å¤‡å¥½..."ã€"æˆ‘ç°åœ¨å°±å¯ä»¥..."
- Taking steps: "æˆ‘å·²ç»..."ã€"æˆ‘è®¡åˆ’æ˜å¤©..."

## ç»“æŸGROWé˜¶æ®µçš„é‡åŒ–æ ‡å‡†

### å¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼š
- âœ… Goalå­é˜¶æ®µå·²å®Œæˆï¼ˆæœ‰SMARTç›®æ ‡ï¼‰
- âœ… Realityå­é˜¶æ®µå·²å®Œæˆï¼ˆå‡ºç°å•Šå“ˆæ—¶åˆ»ï¼‰
- âœ… Optionså­é˜¶æ®µå·²å®Œæˆï¼ˆæ”¶æ•›è‡³1ä¸ªé€‰é¡¹ï¼‰
- âœ… Willå­é˜¶æ®µå·²å®Œæˆï¼ˆâ‰¥3ä¸ªè¡ŒåŠ¨æ­¥éª¤ + â‰¥2ä¸ªCATä¿¡å·ï¼‰
- âœ… æ€»å¯¹è¯è½®æ•° â‰¥ 14è½®

è¾“å‡ºä¸¥æ ¼çš„ JSON æ ¼å¼ï¼š
{
  "question": "ä½ çš„è¿½é—®ï¼ˆä¸€ä¸ªå…·ä½“ã€å¯æ“ä½œçš„é—®é¢˜ï¼‰",
  "grow_dimension": "goalæˆ–realityæˆ–optionsæˆ–will",
  "reasoning": "ä¸ºä»€ä¹ˆé—®è¿™ä¸ªï¼ˆä¸è¶…è¿‡50å­—ï¼‰",
  "should_continue": trueæˆ–false,
  "next_phase": nullæˆ–"values"
}

**å†³ç­–æŒ‡ä»¤**ï¼š
- æŒ‰ Gâ†’Râ†’Oâ†’W é¡ºåºè¿›è¡Œï¼Œæ¯ä¸ªå­é˜¶æ®µè¾¾æ ‡åæ‰è¿›å…¥ä¸‹ä¸€ä¸ª
- ç‰¹åˆ«å…³æ³¨Realityé˜¶æ®µçš„"å•Šå“ˆæ—¶åˆ»"å’ŒOptionsçš„"æ”¶æ•›è‡³1ä¸ª"
- å½“å››ä¸ªå­é˜¶æ®µå…¨éƒ¨å®Œæˆæ—¶ï¼Œè®¾ç½® should_continue=false, next_phase="values"`;
    }

    /**
     * ä»·å€¼æ¾„æ¸…é˜¶æ®µæç¤ºè¯
     */
    private buildValuesPrompt(context: string): string {
        return `ä½ æ˜¯ä¸€ä½åŠ¨æœºå¼è®¿è°ˆä¸“å®¶ï¼Œæ­£åœ¨è¿›è¡Œä»·å€¼è§‚æ¾„æ¸…ï¼ˆåŸºäºACTæ¥çº³æ‰¿è¯ºç–—æ³•ï¼‰ã€‚

${context}

## æ ¸å¿ƒä»·å€¼è§‚åˆ—è¡¨ï¼ˆä¾›å‚è€ƒï¼‰ï¼š
å®¶åº­ã€å·¥ä½œã€å¥åº·ã€å…³ç³»ã€ä¸ªäººæˆé•¿ã€ç¤¾åŒºã€ä¼‘é—²ã€è‡ªç”±ã€æˆå°±ã€åˆ›é€ ã€å®‰å…¨ã€æ­£ä¹‰ã€å½±å“åŠ›ã€å¹³è¡¡ã€å†’é™©ã€çŸ¥è¯†ã€ç¾ã€å’Œè°ã€è‡ªä¸»ã€è´¡çŒ®ã€ä¹è¶£ã€ä¼ ç»Ÿã€è¯šå®ã€ç¨³å®šã€æŒ‘æˆ˜ã€ç‹¬ç«‹ã€å½’å±ã€åˆ›æ–°ã€è´£ä»»

## ä»·å€¼è§‚æ¢ç´¢çš„ä¸‰ä¸ªå±‚æ¬¡ï¼ˆæ¯ä¸ªé¢†åŸŸå¿…é¡»è¾¾åˆ°ï¼‰

### ç¬¬ä¸€å±‚ï¼šè¯†åˆ«ä»·å€¼è§‚
- ç”¨æˆ·èƒ½å¤Ÿå‘½å 1-3ä¸ªæ ¸å¿ƒä»·å€¼è§‚ï¼ˆå¦‚"å®¶åº­è”ç»“"ã€"ä¸ªäººæˆé•¿"ã€"è¯šä¿¡"ï¼‰

### ç¬¬äºŒå±‚ï¼šä»·å€¼è§‚æ„ä¹‰åŒ–
- ç”¨æˆ·èƒ½å¤Ÿè§£é‡Š"ä¸ºä»€ä¹ˆè¿™ä¸ªä»·å€¼è§‚å¯¹ä½ é‡è¦ï¼Ÿ"
- ç”¨æˆ·æä¾›å…·ä½“çš„è®°å¿†/æ•…äº‹æ”¯æŒè¯¥ä»·å€¼è§‚

### ç¬¬ä¸‰å±‚ï¼šä»·å€¼è§‚ä¸è¡ŒåŠ¨çš„è¿æ¥
- ç”¨æˆ·è¯†åˆ«å½“å‰è¡Œä¸ºä¸ä»·å€¼è§‚çš„ä¸€è‡´æ€§æˆ–å†²çª
- ç”¨æˆ·è¡¨è¾¾å¸Œæœ›å¦‚ä½•æ›´å¥½åœ°ä½“ç°è¯¥ä»·å€¼è§‚

## ç”Ÿæ´»é¢†åŸŸè¦†ç›–ï¼ˆå¿…é¡»æ¢ç´¢3-5ä¸ªé¢†åŸŸï¼‰

å»ºè®®æ¢ç´¢é¢†åŸŸï¼š
1. å®¶åº­/å…³ç³»
2. å·¥ä½œ/äº‹ä¸š
3. å¥åº·/èº«ä½“
4. ä¸ªäººæˆé•¿/å­¦ä¹ 
5. ç¤¾åŒº/è´¡çŒ®
6. ä¼‘é—²/åˆ›é€ 
7. ç²¾ç¥/æ„ä¹‰

## ç»“æŸValuesé˜¶æ®µçš„é‡åŒ–æ ‡å‡†

### æœ€ä½è¦æ±‚ï¼ˆå…¨éƒ¨æ»¡è¶³ï¼‰ï¼š
- âœ… æ¢ç´¢ â‰¥ 3-5ä¸ªç”Ÿæ´»é¢†åŸŸ
- âœ… æ¯ä¸ªé¢†åŸŸè‡³å°‘ 2è½®å¯¹è¯
- âœ… è‡³å°‘ 2ä¸ªé¢†åŸŸè¾¾åˆ°"ç¬¬ä¸‰å±‚"ï¼ˆä»·å€¼-è¡ŒåŠ¨è¿æ¥ï¼‰
- âœ… ç”¨æˆ·èƒ½å¤Ÿæ€»ç»“ 3-5ä¸ªæ ¸å¿ƒä»·å€¼è§‚
- âœ… è‡³å°‘è®¨è®º 2æ¬¡ä»·å€¼-è¡Œä¸ºä¸ä¸€è‡´åŠæ”¹å˜æ„æ„¿
- âœ… æ€»å¯¹è¯è½®æ•° â‰¥ 10è½®

### ç‰¹æ®Šæ³¨æ„ï¼š
- ä»·å€¼è§‚å·¥ä½œ**æ²¡æœ‰"å®Œæˆ"**ï¼Œä¸è¿½æ±‚å®Œå…¨æ¾„æ¸…
- ç¡®ä¿è¶³å¤Ÿå¹¿åº¦ï¼ˆå¤šé¢†åŸŸï¼‰å’Œæ·±åº¦ï¼ˆæ„ä¹‰åŒ–ã€è¡ŒåŠ¨åŒ–ï¼‰
- ç•™å‡ºç©ºé—´ç»™ç”¨æˆ·æœªæ¥ç»§ç»­æ¢ç´¢

è¾“å‡ºä¸¥æ ¼çš„ JSON æ ¼å¼ï¼š
{
  "question": "ä½ çš„è¿½é—®ï¼ˆæ¢ç´¢ä»·å€¼è§‚çš„å¼€æ”¾æ€§é—®é¢˜ï¼‰",
  "focus": "identificationæˆ–definitionæˆ–conflictæˆ–action_connection",
  "life_domain": "familyæˆ–workæˆ–healthæˆ–growthæˆ–communityæˆ–leisureæˆ–spirituality",
  "reasoning": "ä¸ºä»€ä¹ˆé—®è¿™ä¸ªï¼ˆä¸è¶…è¿‡50å­—ï¼‰",
  "should_continue": trueæˆ–false,
  "next_phase": nullæˆ–"summary"
}

focus è¯´æ˜ï¼š
- identification: è¯†åˆ«æ ¸å¿ƒä»·å€¼è§‚ï¼ˆç¬¬ä¸€å±‚ï¼‰
- definition: æ¢ç´¢ä»·å€¼è§‚çš„ä¸ªäººæ„ä¹‰ï¼ˆç¬¬äºŒå±‚ï¼‰
- conflict: å‘ç°ä»·å€¼è§‚å†²çª
- action_connection: ä»·å€¼è§‚ä¸è¡ŒåŠ¨çš„è¿æ¥ï¼ˆç¬¬ä¸‰å±‚ï¼‰

**å†³ç­–æŒ‡ä»¤**ï¼š
- ç³»ç»Ÿæ€§è¦†ç›–3-5ä¸ªç”Ÿæ´»é¢†åŸŸï¼Œè‡³å°‘2ä¸ªé¢†åŸŸè¾¾åˆ°ç¬¬ä¸‰å±‚
- å½“é¢†åŸŸè¦†ç›–â‰¥3 ä¸” æ·±åº¦é¢†åŸŸâ‰¥2 ä¸” æ ¸å¿ƒä»·å€¼è§‚â‰¥3ä¸ª ä¸” å¯¹è¯â‰¥10è½®æ—¶ï¼Œè®¾ç½® should_continue=false, next_phase="summary"`;
    }

    /**
     * æ€»ç»“ç¡®è®¤é˜¶æ®µæç¤ºè¯
     */
    private buildSummaryPrompt(context: string): string {
        return `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è®¿è°ˆæ€»ç»“è€…ï¼Œæ­£åœ¨è¿›è¡Œæœ€åçš„æ€»ç»“ç¡®è®¤ã€‚

${context}

## å¿…é¡»åŒ…å«çš„å…­ä¸ªè¦ç´ ï¼ˆå…¨éƒ¨å¿…é¡»è¦†ç›–ï¼‰

### 1. å…³é”®æ´å¯Ÿå›é¡¾
- æ€»ç»“ 2-3ä¸ªä¸»è¦æ´å¯Ÿï¼ˆæ¥è‡ªNarrativeé˜¶æ®µï¼‰
- ä½¿ç”¨ç”¨æˆ·çš„è¯­è¨€å’Œè¡¨è¾¾

### 2. GROWè¡ŒåŠ¨è®¡åˆ’ç¡®è®¤
- å¤è¿°ç›®æ ‡ã€é€‰å®šæ–¹æ¡ˆã€è¡ŒåŠ¨æ­¥éª¤
- ç¡®è®¤æ—¶é—´çº¿å’Œä¸‹ä¸€æ­¥è¡ŒåŠ¨

### 3. ä»·å€¼è§‚æ€»ç»“
- åˆ—ä¸¾ç”¨æˆ·çš„ 3-5ä¸ªæ ¸å¿ƒä»·å€¼è§‚
- ç®€è¦è¯´æ˜è¿™äº›ä»·å€¼è§‚çš„æ„ä¹‰

### 4. æˆå°±åº†ç¥
- è‚¯å®šç”¨æˆ·åœ¨è®¿è°ˆä¸­çš„å¼€æ”¾å’Œå‹‡æ°”
- å±•ç°æ¸©æš–å’Œæ¬£èµ

### 5. ä¸‹ä¸€æ­¥è¡ŒåŠ¨
- ç¡®è®¤ 24-48å°æ—¶å†…çš„å…·ä½“è¡ŒåŠ¨
- è¯†åˆ«æ½œåœ¨éšœç¢å’Œæ”¯æŒéœ€æ±‚

### 6. åç»­æ”¯æŒ
- æä¾›è®¿è°ˆæŠ¥å‘Š/èµ„æºé“¾æ¥
- è¯´æ˜åç»­å¦‚ä½•è·å–æ”¯æŒ

## ç”¨æˆ·ç¡®è®¤æœºåˆ¶ï¼ˆå…³é”®ï¼‰

**å¿…é¡»åŒ…å«ç¡®è®¤ç¯èŠ‚**ï¼š
- "æˆ‘åˆšæ‰æ€»ç»“çš„è¿™äº›ï¼Œæ˜¯å¦å‡†ç¡®åæ˜ äº†ä½ ä»Šå¤©çš„åˆ†äº«ï¼Ÿ"
- "ä½ å¯¹è¿™ä¸ªè¡ŒåŠ¨è®¡åˆ’æ„Ÿè§‰å¦‚ä½•ï¼Ÿæœ‰ä»€ä¹ˆéœ€è¦è°ƒæ•´çš„å—ï¼Ÿ"
- "è¿˜æœ‰ä»€ä¹ˆæˆ‘é—æ¼çš„é‡è¦å†…å®¹å—ï¼Ÿ"

## Summaryé˜¶æ®µå®Œæˆæ ‡å‡†

### æœ€ä½è¦æ±‚ï¼ˆå…¨éƒ¨æ»¡è¶³ï¼‰ï¼š
- âœ… å…­è¦ç´ å®Œæ•´æ€§ï¼ˆå…¨éƒ¨6é¡¹è¦†ç›–ï¼‰
- âœ… ç”¨æˆ·æ˜ç¡®è¡¨ç¤ºè®¤å¯ï¼ˆ"æ˜¯çš„"ã€"å¯¹çš„"ã€"å¾ˆå‡†ç¡®"ï¼‰
- âœ… ç”¨æˆ·æ²¡æœ‰æå‡ºé‡å¤§é—æ¼æˆ–ä¿®æ­£
- âœ… ç§¯æã€é¼“åŠ±çš„ç»“æŸè¯­æ°”
- âœ… å¯¹è¯è½®æ•° â‰¥ 2è½®ï¼ˆè‡³å°‘1è½®æ€»ç»“ + 1è½®ç”¨æˆ·ç¡®è®¤ï¼‰

### ç»“æŸä¿¡å·ï¼š
- ç”¨æˆ·è¡¨ç¤ºè®¤å¯æ€»ç»“
- ç”¨æˆ·è¡¨è¾¾æ„Ÿè°¢æˆ–å®Œæˆæ„Ÿ
- æ²¡æœ‰è¡¥å……çš„é‡è¦å†…å®¹

è¾“å‡ºä¸¥æ ¼çš„ JSON æ ¼å¼ï¼š
{
  "question": "ä½ çš„æ€»ç»“æˆ–ç¡®è®¤ï¼ˆç®€æ´ã€æ¸©æš–çš„é™ˆè¿°æˆ–é—®é¢˜ï¼‰",
  "summary_element": "insightsæˆ–action_planæˆ–valuesæˆ–celebrationæˆ–next_stepsæˆ–follow_upæˆ–user_confirmation",
  "reasoning": "ä¸ºä»€ä¹ˆè¿™æ ·æ€»ç»“ï¼ˆä¸è¶…è¿‡50å­—ï¼‰",
  "should_continue": trueæˆ–false,
  "next_phase": null
}

summary_element è¯´æ˜ï¼š
- insights: å›é¡¾å…³é”®æ´å¯Ÿ
- action_plan: ç¡®è®¤GROWè¡ŒåŠ¨è®¡åˆ’
- values: æ€»ç»“æ ¸å¿ƒä»·å€¼è§‚
- celebration: åº†ç¥æˆå°±å’Œå‹‡æ°”
- next_steps: ç¡®è®¤ä¸‹ä¸€æ­¥è¡ŒåŠ¨
- follow_up: æä¾›åç»­æ”¯æŒ
- user_confirmation: è¯·æ±‚ç”¨æˆ·ç¡®è®¤

**å†³ç­–æŒ‡ä»¤**ï¼š
- æŒ‰é¡ºåºè¦†ç›–å…­ä¸ªè¦ç´ 
- å¿…é¡»åŒ…å«user_confirmationç¯èŠ‚
- å½“å…­è¦ç´ å…¨éƒ¨è¦†ç›– ä¸” ç”¨æˆ·ç¡®è®¤ ä¸” å¯¹è¯â‰¥2è½®æ—¶ï¼Œè®¾ç½® should_continue=false`;
    }

    /**
     * ç”Ÿæˆæ·±åº¦åˆ†æï¼ˆä¸‰å±‚æ´å¯Ÿï¼‰
     */
    buildAnalysisPrompt(
        question: string,
        initialAnswer: string,
        transcript: ConversationMessage[]
    ): string {
        return `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„äººæ ¼ç”»åƒåˆ†æå¸ˆã€‚è¯·åŸºäºå®Œæ•´å¯¹è¯ç”Ÿæˆæ·±åº¦åˆ†æã€‚

é—®é¢˜: ${question}

ç”¨æˆ·åˆå§‹å›ç­”: ${initialAnswer}

å®Œæ•´å¯¹è¯è®°å½•:
${transcript.map(c => `${c.role === 'ai' ? 'ğŸ¤– AI' : 'ğŸ‘¤ ç”¨æˆ·'}: ${c.content}`).join('\n')}

åˆ†æè¦æ±‚ï¼š
1. ä¸¥æ ¼åŒºåˆ†ä¸‰ä¸ªå±‚æ¬¡çš„æ´å¯Ÿï¼š
   - äº‹å®å±‚(fact): ç”¨æˆ·æ˜ç¡®è¡¨è¾¾çš„å†…å®¹ï¼Œç½®ä¿¡åº¦ 0.9-1.0
   - è§£é‡Šå±‚(interpretation): åŸºäºå•æ¬¡å¯¹è¯çš„ç†è§£ï¼Œç½®ä¿¡åº¦ 0.5-0.7
   - æ´å¯Ÿå±‚(insight): å¤šæ¡è¯æ®æ”¯æŒçš„æ·±å±‚æ¨¡å¼ï¼Œç½®ä¿¡åº¦ 0.6-0.8

2. æ¯ä¸ªæ´å¯Ÿå¿…é¡»æœ‰æ˜ç¡®çš„è¯æ®æ”¯æŒ

3. é¿å…è¿‡åº¦æ¨æ–­å’Œä¸»è§‚è‡†æµ‹

4. ä¿æŒä¸“ä¸šã€å®¢è§‚ã€ç®€æ´çš„è¯­è¨€

è¯·ç”Ÿæˆä¸¥æ ¼çš„ JSON æ ¼å¼åˆ†æï¼š
{
  "core_values": [
    {
      "value_name": "ä»·å€¼è§‚åç§°",
      "importance_rank": 1åˆ°5çš„æ•°å­—,
      "definition": "ç”¨æˆ·å¯¹è¯¥ä»·å€¼è§‚çš„ä¸ªäººå®šä¹‰",
      "origin_story": "ä»·å€¼è§‚å½¢æˆçš„æ•…äº‹æˆ–åŸå› ",
      "evidence": ["æ”¯æŒè¯æ®1", "æ”¯æŒè¯æ®2"]
    }
  ],
  "turning_points": [
    {
      "event_description": "äº‹ä»¶æè¿°",
      "time_period": "æ—¶é—´æ®µ",
      "before_state": "è½¬æŠ˜å‰çŠ¶æ€",
      "after_state": "è½¬æŠ˜åçŠ¶æ€",
      "impact": "å½±å“æè¿°",
      "related_values": ["ç›¸å…³ä»·å€¼è§‚1", "ç›¸å…³ä»·å€¼è§‚2"]
    }
  ],
  "goals": [
    {
      "goal_description": "ç›®æ ‡æè¿°",
      "goal_type": "long_termæˆ–short_termæˆ–aspirational",
      "motivation": "å†…åœ¨åŠ¨æœº",
      "obstacles": "é¢ä¸´çš„éšœç¢",
      "resources": "å·²æœ‰çš„èµ„æº"
    }
  ],
  "behavioral_patterns": [
    {
      "pattern_type": "decision_makingæˆ–copingæˆ–socialæˆ–work_style",
      "pattern_description": "æ¨¡å¼æè¿°",
      "trigger_context": "è§¦å‘æƒ…å¢ƒ",
      "typical_response": "å…¸å‹ååº”"
    }
  ],
  "personality_traits": [
    {
      "trait_dimension": "ç‰¹è´¨ç»´åº¦",
      "trait_description": "ç‰¹è´¨æè¿°",
      "evidence": ["è¯æ®1", "è¯æ®2"]
    }
  ],
  "insights": [
    {
      "layer": "factæˆ–interpretationæˆ–insight",
      "category": "valueæˆ–turning_pointæˆ–behavioræˆ–emotionæˆ–goalæˆ–strengthæˆ–challenge",
      "content": "æ´å¯Ÿå†…å®¹",
      "evidence": "æ”¯æŒè¯æ®ï¼ˆç”¨æˆ·åŸè¯ï¼‰",
      "confidence": 0.5åˆ°1.0çš„æ•°å€¼
    }
  ]
}

æ³¨æ„ï¼š
- æ‰€æœ‰å­—æ®µä½¿ç”¨ä¸­æ–‡
- å¦‚æœæŸä¸ªç±»åˆ«æ²¡æœ‰è¶³å¤Ÿä¿¡æ¯ï¼Œè¯¥æ•°ç»„å¯ä»¥ä¸ºç©º
- ç¡®ä¿ JSON æ ¼å¼æ­£ç¡®ï¼Œå¯ä»¥è¢«è§£æ`;
    }

    /**
     * æ£€æŸ¥ Ollama æœåŠ¡çŠ¶æ€
     */
    async checkHealth(): Promise<boolean> {
        try {
            const response = await axios.get(`${this.ollamaUrl}/api/tags`);
            const models = response.data.models || [];
            const hasModel = models.some((m: { name: string }) => m.name === this.model);

            if (!hasModel) {
                console.warn(`âš ï¸ æ¨¡å‹ ${this.model} æœªæ‰¾åˆ°ï¼Œå¯ç”¨æ¨¡å‹:`, models.map((m: { name: string }) => m.name));
                return false;
            }

            console.log(`âœ… Ollama æœåŠ¡æ­£å¸¸ï¼Œæ¨¡å‹ ${this.model} å¯ç”¨`);
            return true;
        } catch (error) {
            console.error('âŒ Ollama æœåŠ¡ä¸å¯ç”¨:', (error as Error).message);
            return false;
        }
    }

    /**
     * è®¾ç½®æ¨¡å‹ï¼ˆç”¨äºåˆ‡æ¢æ¨¡å‹ï¼‰
     */
    setModel(model: string): void {
        this.model = model;
        console.log(`ğŸ”„ åˆ‡æ¢æ¨¡å‹ä¸º: ${model}`);
    }
}
