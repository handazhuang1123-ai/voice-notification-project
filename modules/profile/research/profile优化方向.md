# 个人画像系统优化方向讨论文档

**创建时间**: 2025-01-27
**讨论人员**: 壮爸 + Claude
**背景**: 基于《访谈阶段转换标准研究报告》和《Qwen长对话性能研究报告》的深度讨论

---

## 📋 优化目标

从**体验性**和**必要性**角度完善个人画像功能，**不以降低答题轮数为目的**，一切从功能合理、必要的前提下再考虑简洁。

---

## 🎯 方向1：问卷设计逻辑的理论基础

### 核心问题

当前系统采用五阶段访谈流程：
```
Opening（开场破冰，5分钟）
    ↓
Narrative（叙事深挖，30分钟，DICE技术）
    ↓
GROW（目标教练，20分钟，GROW模型）
    ↓
Values（价值观探索，15分钟，ACT疗法）
    ↓
Summary（总结确认，5分钟）
```

**需要回答的关键问题**：

1. **这五个阶段是紧密衔接的关系吗？**
   - 是否存在内在逻辑联系？
   - 还是独立的模块化组件？

2. **是一套完善的流程体系还是多个理论研究的拼接产物？**
   - Opening + Narrative：来自**质性研究访谈法**（DICE技术）
   - GROW：来自**教练技术**
   - Values：来自**ACT疗法**（Acceptance Commitment Therapy）
   - Summary：通用访谈收尾
   - **初步判断**：看起来是**多个理论的拼接**，而非单一体系

3. **一套正常的问卷流程是否必须经历这五个阶段才算完善？**
   - 每个阶段的必要性如何？
   - 是否存在可替代方案？
   - 是否有更成熟的整合框架？

### 待研究内容

#### 研究任务1：五阶段理论关系分析
**研究问题**：
- 质性研究访谈法 + 教练技术 + ACT疗法 的整合框架是否有文献支持？
- 是否存在更成熟的"深度访谈+教练+心理治疗"整合体系？
- 每个阶段的理论边界在哪里？是否有重叠或冲突？

**预期产出**：
- 五阶段理论关系图谱
- 各阶段的必要性评估（必要/推荐/可选）
- 替代方案建议

#### 研究任务2：各阶段的可替代性评估
**评估维度**：
- **Opening**：是否可以省略或合并到Narrative？
- **Narrative vs GROW**：是否存在功能重叠？
- **Values**：是否适合所有用户群体？
- **Summary**：人工确认 vs AI自动生成的权衡

**评估方法**：
- 查找深度访谈最佳实践文献
- 查找教练技术标准流程
- 查找ACT疗法应用场景

### 预期产出

**文档**: `五阶段问卷设计理论基础研究报告.md`

**内容**：
1. 五阶段的理论来源与关系分析
2. 每个阶段的必要性评估
3. 阶段间的衔接逻辑（紧密/松散/独立）
4. 可选的优化方案：
   - 方案A：保持五阶段（当前）
   - 方案B：合并相似阶段
   - 方案C：采用其他成熟框架
5. 针对"个人画像"场景的推荐方案

**预计时间**: 20-30分钟

---

## 🤖 方向2：后端模型与架构优化

### 2.1 模型选择：寻找更优方案

#### 当前问题
- **Qwen2.5:14b** 存在已知的重复输出bug（GitHub Issue #920）
- 长对话中出现同质化问题，不充分结合已给出的回答

#### 候选模型对比

| 模型 | 参数量 | 上下文 | 优势 | 劣势 | 推荐度 |
|------|--------|--------|------|------|--------|
| **qwen2.5:14b-instruct** | 14B | 128K | 中文能力强，速度快 | 重复输出bug | ⭐⭐⭐ |
| **deepseek-v2.5** | 236B MoE | 128K | 推理能力强，无重复bug，用户有使用经验 | 体积大（~140GB），速度慢 | ⭐⭐⭐⭐ |
| **qwen3:14b** | 14B | 128K | 修复了重复bug，性能提升 | 尚未正式发布 | ⭐⭐⭐⭐⭐（未来） |
| **llama3.1:8b** | 8B | 128K | 速度快，体积小 | 中文能力较弱 | ⭐⭐ |
| **gemma2:27b** | 27B | 8K | 质量高 | 上下文太短 | ⭐ |

#### 待验证任务

**任务1**: 测试 deepseek-v2.5 的访谈效果
- 对比同一问题在qwen2.5和deepseek-v2.5下的表现
- 重点观察：重复问题、上下文利用、阶段判断准确性
- 测试方法：用相同的conversation_history调用两个模型

**任务2**: 关注 qwen3:14b 的发布进度
- Ollama官方仓库监控
- 发布后立即测试

**任务3**: 参数优化
- 当前未设置 `repeat_penalty`，默认为1.0
- 研究报告建议：设置为1.3
- 需要创建Modelfile或直接在API调用时指定

---

### 2.2 架构优化：追问与阶段判断分离

#### 当前架构的问题

**职责混乱**：
```typescript
// 当前：一个函数同时负责两件事
POST /generate-followup
  ↓
buildPhasePrompt()  // 同时要求AI：
  - 生成下一个追问
  - 判断是否转换阶段
  - 返回 {question, should_continue, next_phase}
```

**问题**：
1. **职责不单一**：生成问题和判断阶段是两个完全不同的任务
2. **模型负担重**：一次调用要求AI做两种决策
3. **难以调试**：无法单独优化追问质量或阶段判断准确性
4. **资源浪费**：阶段判断可以用更轻量的方法实现

#### 优化方案A：两个独立系统

```typescript
// 方案A：双系统架构
POST /generate-followup
  ↓
  1. generateFollowupQuestion()  // 专注生成追问
     - 输入：conversation_history, current_phase
     - 输出：{question, dice_type, reasoning}

  2. evaluatePhaseTransition()   // 专门判断阶段
     - 输入：conversation_history, current_phase
     - 输出：{should_continue, next_phase, reasons}
```

**优点**：
- 职责清晰
- 可以独立优化
- 阶段判断可以用规则引擎或更小的模型

#### 优化方案B：5个专门的阶段判断器（推荐）

```typescript
// 方案B：五个独立判断器
POST /generate-followup
  ↓
  1. generateFollowupQuestion()  // 统一追问生成器

  2. 根据 current_phase 调用对应判断器：
     - evaluateOpeningComplete()    // 3-5轮，信任建立信号
     - evaluateNarrativeComplete()  // 12轮，编码饱和+意义饱和
     - evaluateGROWComplete()       // 14轮，4子阶段完成
     - evaluateValuesComplete()     // 10轮，3-5领域×3层
     // Summary阶段不需要判断器（6要素检查表）
```

**优点**：
- 每个阶段的判断标准完全不同，独立函数更合理
- 可以针对性优化（Opening可以用规则，GROW可能需要模型）
- 更容易测试和调试
- 可以使用不同的判断策略（规则/小模型/大模型）

#### 实施建议

**阶段1：最小改动验证**
```typescript
// 保持现有API，内部分离调用
async function handleGenerateFollowup() {
  const question = await generateQuestion(history, phase);
  const transition = await evaluateTransition(history, phase);
  return { question, ...transition };
}
```

**阶段2：完全重构**
```typescript
// 新增独立API
POST /generate-followup        // 只生成问题
POST /evaluate-phase-transition  // 只判断阶段
```

---

### 2.3 上下文管理：定期总结机制

#### 问题背景

研究报告指出：
- Qwen2.5上下文窗口128K，但性能在64K后下降25.7%
- 长对话中会累积大量上下文
- 给本地模型提供**清爽的上下文**可以提高准确性

#### 优化策略1：滑动窗口 + 定期总结

```typescript
// 每5轮对话后自动总结
if (conversationHistory.length % 5 === 0) {
  const summary = await summarizeLastRounds(5);

  // 压缩上下文
  conversationHistory = [
    ...earlyHistory,  // 保留最早3轮（破冰信息）
    { role: 'system', content: `[轮次${n-4}~${n}总结]: ${summary}` },
    ...recentHistory  // 保留最近3轮原文
  ];
}
```

**总结生成示例**：
```
[轮次6~10总结]:
- 用户分享了职业转型的三个关键时刻（2019创业失败、2021加入大厂、2023离职）
- 核心困惑：不确定当前方向是否符合长期价值观
- 情绪状态：焦虑但有行动意愿
- 已探索领域：职业、人际关系
```

#### 优化策略2：分阶段保留策略

```typescript
// 不同阶段保留不同信息
const contextStrategy = {
  opening: {
    keep: 'all',  // 破冰阶段全部保留（轮次少）
  },
  narrative: {
    keep: 'recent_5 + summaries',  // 保留最近5轮 + 之前的总结
    summarize_every: 5
  },
  grow: {
    keep: 'recent_3 + goal_statement + reality_insights',  // 保留关键信息
    summarize_every: 5
  },
  values: {
    keep: 'recent_3 + identified_values',
    summarize_every: 5
  }
};
```

#### 优化策略3：智能总结（关键信息提取）

```typescript
// 不是简单摘要，而是提取结构化信息
interface NarrativeSummary {
  key_events: string[];        // 关键事件列表
  emotions: string[];          // 情绪词汇
  recurring_themes: string[];  // 重复出现的主题
  insights: string[];          // 用户的自我洞察
}
```

#### 实施建议

**短期**（立即可实施）：
- 在 `ollama-service.ts` 添加简单的轮次统计
- 每10轮手动触发一次总结生成（调用Ollama生成摘要）

**中期**（需要架构调整）：
- 实现自动滑动窗口
- 添加总结缓存（避免重复生成）

**长期**（需要数据库支持）：
- 在数据库中存储阶段性总结
- 用户可以查看历史总结

---

## 📊 优先级建议

### 优先级1：理论研究（影响所有后续决策）⏰ 20-30分钟

**任务**: 启动五阶段问卷设计理论基础研究
- 使用 `web-research-specialist` agent
- 产出: `五阶段问卷设计理论基础研究报告.md`

**为什么优先**：
- 直接回答"是否需要全部五个阶段"的核心问题
- 影响后续的架构设计（是否需要5个独立判断器）
- 可能发现更优的整体框架

---

### 优先级2：快速验证（立即可测试）⏰ 10-15分钟

**任务A**: 测试 deepseek-v2.5 模型
- 对比qwen2.5的重复问题是否改善
- 评估速度是否可接受

**任务B**: 优化当前模型参数
- 设置 `repeat_penalty: 1.3`
- 测试效果

**为什么优先**：
- 成本低，见效快
- 可以立即改善用户体验
- 不需要架构调整

---

### 优先级3：架构重构（需要时间，但影响深远）⏰ 1-2小时

**阶段1**: 追问/判断分离（最小改动）
- 保持现有API
- 内部分离两次调用

**阶段2**: 实施5个独立阶段判断器
- 基于理论研究结果决定是否需要

**阶段3**: 上下文管理
- 实施滑动窗口
- 实施定期总结

**为什么靠后**：
- 需要理论研究结果指导
- 需要模型测试结果验证
- 改动较大，需要充分测试

---

## 🚀 下一步行动

**壮爸决策点**：

1. **是否启动理论研究？**
   - [ ] 是，立即启动五阶段理论基础研究
   - [ ] 否，先做快速验证

2. **是否测试deepseek-v2.5？**
   - [ ] 是，立即测试
   - [ ] 否，先优化qwen2.5参数

3. **架构重构的态度**
   - [ ] 积极推进，尽快实施
   - [ ] 保守观望，等研究结果
   - [ ] 暂缓，专注体验优化

4. **其他想法或疑虑**
   - （请补充）

---

## 📝 讨论记录

### 2025-01-27 初次讨论

**壮爸的核心关切**：
- 体验性和必要性是第一位的，不是降低轮数
- 不要轻易用简洁方案替代
- 功能合理、必要是前提

**Claude的回应**：
- 五阶段确实看起来是拼接产物，需要研究验证
- deepseek-v2.5可能是更好的模型选择
- 追问/判断分离是正确的架构方向
- 上下文管理对本地模型至关重要

**达成共识**：
- 先创建本文档，系统化整理问题
- 后续根据优先级逐一推进

---

## 附录：相关文档

- [访谈阶段转换标准研究报告](./访谈阶段转换标准研究报告.md)
- [Qwen长对话性能研究报告](./Qwen长对话性能研究报告.md)
- `ollama-service.ts`: 当前AI服务实现
- `Interview.tsx`: 前端访谈页面

---

**文档状态**: 🟡 讨论中
**最后更新**: 2025-01-27
**负责人**: 壮爸
